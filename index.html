<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interaktive Lernsituation – Haus (Hotspots)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300..700&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">

  <style>
    :root{
          /* Einfach hier austauschen = globale Schrift ändern */
          --font-body: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Arial, "Helvetica Neue", sans-serif;
          --font-heading: "Merriweather", Georgia, "Times New Roman", serif;
        }

        /* Global (UI & Text) */
        body{ font-family: var(--font-body); }

        /* Überschriften (Infos/Panels) */
        .slide-content .info-card header,
        .slide-content .info-card header *{
          font-family: var(--font-heading);
        }

        /* Nur Info-Text (falls du NUR dort ändern willst) */
        .slide-content .info-card .info-content,
        #slideDesc{ font-family: var(--font-body); }

    :root{ --bg:#0b1020; --panel:#11162a; --text:#eaf0ff; --muted:#a6b0cf; --accent:#7aa2ff; --ring: rgba(122,162,255,.35); --shadow: 0 10px 30px rgba(0,0,0,.35); }
    html,body{height:100%;}
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; color:var(--text); background: radial-gradient(1200px 600px at 10% -10%, #15204b 0%, transparent 50%), var(--bg); display:flex; align-items:center; justify-content:center; padding:16px; }
    .app{ width:100%; max-width:980px; }
    .card{ background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius:18px; box-shadow:var(--shadow); overflow:hidden; }
    .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.06);} 
    .header h1{ font-size:18px; margin:0; }
    .header small{ color:var(--muted); display:block; }
    .header .right{ display:flex; align-items:center; gap:8px; }
    .badge{ display:none; padding:4px 8px; border-radius:999px; background:#1f2a57; border:1px solid rgba(255,255,255,.16); font-size:12px; }
    body.is-admin .badge{ display:inline-block; }
    .admin-btn{ background:#18224a; color:#fff; border:1px solid rgba(255,255,255,.2); border-radius:10px; padding:6px 10px; cursor:pointer; }

    .wrap{ position:relative; width:100%; background:#0f1330; overflow:hidden; }
    .wrap img{ width:100%; height:auto; display:block; aspect-ratio:16/10; object-fit:cover; }
    .overlay{ position:absolute; inset:0; pointer-events:auto; z-index:1; }
    .hotspot{ cursor:pointer; }
    .label{ font-size:11px; fill:#fff; paint-order:stroke; stroke:rgba(0,0,0,.45); stroke-width:3px; font-weight:700; }
    .poly-fill{ fill: rgba(122,162,255,.18); pointer-events:all; stroke: var(--accent); stroke-width:.8; filter: drop-shadow(0 2px 6px var(--ring)); }

    .toolbar{ position:relative; z-index:3; display:flex; flex-wrap:wrap; align-items:center; gap:8px; padding:10px 16px; border-top:1px solid rgba(255,255,255,.06); background:rgba(15,19,48,0.9); }
    .toolbar label, .toolbar select, .toolbar input[type="text"]{
      background:#18224a; color:#fff; border:1px solid rgba(255,255,255,.16);
      border-radius:12px; padding:8px 12px; cursor:pointer;
      }
    .toolbar select{ padding-right:28px; }
    .toolbar input[type="file"]{ display:none; }

    /* USER-MODUS: Hotspots unsichtbar, aber klickbar */
    body:not(.is-admin) .poly-fill{
      fill: transparent !important;
      fill-opacity: 0 !important;
      stroke: transparent !important;
      stroke-opacity: 0 !important;
      stroke-width: 0 !important;
      filter: none !important;
      -webkit-filter: none !important;
      pointer-events: all !important; /* SVG bleibt klickbar, auch wenn unsichtbar */
    }
    body:not(.is-admin) .label{ display:none !important; }
    /* Sicherheitsnetz für temporäre Edit-/Mess-Ebenen */
    body:not(.is-admin) #editLayer,
    body:not(.is-admin) #measureLayer{ display:none !important; }

    /* Sichtbarkeit per Admin */
    .admin-only.inline{ display:none !important; }
    body.is-admin .admin-only.inline{ display:inline-block !important; }
    .admin-only.flex{ display:none !important; }
    body.is-admin .admin-only.flex{ display:flex !important; }

    /* Wenn Modal offen ist, App darunter ausblenden (sicher & barriereärmer) */
    body.modal-open .app{ display:none !important; }


    .hint{ padding:8px 16px 14px; color:var(--muted); font-size:13px; }
    .hint code{ background:rgba(255,255,255,.08); padding:2px 6px; border-radius:6px; }
    .warn{ color:#ffbaba; }

    /* SLIDE (neue "Folie") */
    .slide{ position:fixed; inset:0; z-index:50; display:grid; grid-template-rows: 1fr auto; background: #0a0f25; transform: translateY(100%); transition: transform .4s ease; }
    .slide.open{ transform: translateY(0); }
    .slide-bg{ position:relative; overflow:hidden; background:#0a0f25; }
    .slide-bg img{ width:100%; height:100%; object-fit:cover; transform-origin: top left; will-change: transform; transition: transform .3s ease; display:block; }
    .slide-content{ background: linear-gradient(180deg, rgba(17,22,42,.96), rgba(17,22,42,.94)); border-top-left-radius:18px; border-top-right-radius:18px; box-shadow:var(--shadow); padding:12px 16px 18px; max-height: 45vh; overflow:auto; }
    .slide-content h2{ margin:0 0 6px; font-size:18px; }
    .slide-content .meta{ color:var(--muted); font-size:12px; margin-bottom:8px; }


    @media (min-width: 860px){
      .slide{ grid-template-columns: 1.2fr .8fr; grid-template-rows: 1fr; }
      .slide-content{ border-top-left-radius:0; height:100%; max-height:none; border-left:1px solid rgba(255,255,255,.06); }
    }

/* Lightbox */
.lightbox{
  position: fixed; inset: 0; z-index: 100;
  background: rgba(10,15,37,.98);
  display: grid;
  grid-template-areas: "prev img next" "meta meta meta";
  align-items: center; justify-items: center;
}
.lb-img{
  grid-area: img;
  box-shadow: var(--shadow);
}
.lb-meta{
  grid-area: meta;
  color: var(--muted);
  padding: 8px 16px 16px;
  text-align: center;
}
.lb-close{
  position: absolute; top: 10px; right: 10px;
  background:#18224a; color:#fff; border:1px solid rgba(255,255,255,.2);
  border-radius:12px; padding:8px 12px; cursor:pointer;
}
.lb-nav{
  background: rgba(24,34,74,.8);
  border: 1px solid rgba(255,255,255,.25);
  color:#fff; border-radius:12px; cursor:pointer;
  font-size: 28px;
  user-select: none;
}

/* Rollen-Modal */
.role-modal{
  position: fixed; inset: 0; z-index: 1000;
  background: rgb(13, 37, 10);
  display: grid; place-items: center;
}
.role-card{
  width: min(520px, 92vw);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.12);
  border-radius:16px; padding:20px; box-shadow: var(--shadow);
  text-align:center;
}
.role-card h2{ margin:0 0 8px; }
.role-card p{ color:var(--muted); margin:0 0 16px; }
.role-actions{ display:flex; gap:12px; justify-content:center; }
.role-btn{
  background:#18224a; color:#fff; border:1px solid rgba(255,255,255,.2);
  border-radius:12px; padding:10px 16px; cursor:pointer; font-size:16px;
}

/* Admin-Button komplett verstecken (wir starten nur noch über den Dialog) */
.header .right{ display:none !important; }

/* Sichtbarer Hotspot-Button (z. B. für 'Keller') */
.hotspot-btn{
  position:absolute;
  transform: translate(-50%, -50%);
  background: transparent; /* kein Hintergrund */
  border: none;            /* keine Umrandung */
  padding: 0;              /* kein Padding */
  color: #fff;             /* Icon-Farbe (currentColor) */
  cursor: pointer;
  line-height: 1;
  z-index: 2;
}

/* Größe des SVG-Icons */
.hotspot-btn svg{
  width: 80px;
  height: 80px;
  display: block;
}

.hotspot-btn:hover{ filter: brightness(1.05); }
/* ===== Responsive-Overlays & Typo ===== */
html { font-size: clamp(14px, 1.6vw, 16px); }
.header h1 { font-size: clamp(16px, 2.4vw, 20px); }
.header small { font-size: clamp(11px, 1.5vw, 13px); }

.app { max-width: min(100%, 1100px); }

/* Bildfläche: volle Breite, Overlay bleibt deckungsgleich */
.wrap { width: 100%; }
.wrap img { width: 100%; height: auto; display: block; }

/* Toolbar: bricht sauber um, größere Touch-Ziele */
.toolbar { gap: 10px; }
.toolbar button,
.toolbar label,
.toolbar select,
.toolbar input[type="text"]{
  font-size: clamp(12px, 1.8vw, 14px);
  padding: clamp(8px, 1.6vw, 10px) clamp(10px, 2vw, 14px);
  min-height: 40px; /* Touch-Ziel */
}

/* Slide: Content-Höhe auf Mobile angenehmer, ohne Scroll-Hölle */
.slide { height: 100svh; } /* sicheres Viewport-Height auf iOS/Android */
.slide-content { max-height: 45svh; }
@media (max-width: 860px){
  .slide-content { max-height: 50svh; }
}




/* Lightbox schon gut – auf sehr kleinen Screens noch kompakter */
@media (max-width: 480px){
  .lb-img{ max-height: 68svh; }
  .lb-nav{ width: 38px; height: 38px; font-size: 22px; }
}

/* Rollen-Dialog: kompakter auf Phones */
.role-card{
  width: min(520px, 94vw);
  padding: clamp(16px, 4vw, 22px);
}
.role-actions{ gap: clamp(8px, 2.5vw, 12px); }
.role-btn{
  font-size: clamp(14px, 2vw, 16px);
  padding: clamp(8px, 2.2vw, 12px) clamp(12px, 3vw, 16px);
}

/* Sichtbarer Hotspot-Button (z.B. Keller): skaliert mit Viewport */
.hotspot-btn svg{
  width: clamp(28px, 7vw, 80px);
  height: clamp(28px, 7vw, 80px);
}

/* Labels im Admin: skalieren */
.label{ font-size: clamp(10px, 1.8vw, 12px); }

/* Kleinere Screens: Header enger, Abstände leicht reduziert */
@media (max-width: 600px){
  .header{ padding: 10px 12px; }
  .toolbar{ padding: 8px 12px; }
}
/* Wenn die Slide den Contain-Modus bekommt, Bild vollständig einpassen */
.slide--contain .slide-bg{
  display:flex;
  align-items:center;
  justify-content:center;
}
.slide--contain .slide-bg img{
  width:100%;
  height:100%;
  object-fit: contain;      /* statt cover -> kein Beschnitt */
  background:#0a0f25;       /* ruhiger Rand, falls Letterboxing */
}

/* Lightbox: auf Phones noch mehr Höhe erlauben + “safe” viewport */
.lb-img{
  max-width: 100vw;
  max-height: 85svh;        /* statt 80vh -> stabiler auf Mobile */
  width:auto; height:auto;
  object-fit: contain;
}
/* ===== Mobile-sichere Lightbox-Geometrie ===== */
:root{
  --navW: clamp(48px, 12vw, 72px);   /* Breite der Pfeil-Buttons links/rechts */
  --metaH: clamp(32px, 7vh, 64px);   /* Höhe der Meta-Zeile unten */
  --pad: 12px;                       /* Innenabstand für Luft */
}

/* Grid so begrenzen, dass nix übersteht; Safe-Area beachten (iOS) */
.lightbox{
  position: fixed; inset: 0; z-index: 100;
  display: grid;
  grid-template-areas: "prev img next" "meta meta meta";
  grid-template-columns: var(--navW) 1fr var(--navW);
  grid-template-rows: 1fr auto;
  padding:
    calc(env(safe-area-inset-top, 0px) + var(--pad))
    calc(env(safe-area-inset-right, 0px) + var(--pad))
    calc(env(safe-area-inset-bottom, 0px) + var(--pad))
    calc(env(safe-area-inset-left, 0px) + var(--pad));
  background: rgba(10,15,37,.98);
  overflow: hidden;             /* WICHTIG: kein Scroll/Überstand */
  align-items: center; justify-items: center;
}

/* Bild strikt innerhalb von Viewport minus Pfeile & Meta-Zeile */
.lb-img{
  grid-area: img;
  display: block;
  width: auto; height: auto;
  max-width: calc(100vw - (var(--navW)*2) - (var(--pad)*2));
  max-height: calc(100svh - var(--metaH) - (var(--pad)*2));
  object-fit: contain !important;   /* erzwingen, falls woanders überschrieben */
}

/* Navi-Buttons & Meta-Zeile an neue Variablen koppeln */
.lb-nav{ width: var(--navW); height: var(--navW); font-size: clamp(20px, 5vw, 28px); }
.lb-prev{ grid-area: prev; }
.lb-next{ grid-area: next; }

.lb-meta{
  grid-area: meta;
  min-height: var(--metaH);
  display:flex; align-items:center; justify-content:center;
  padding-top: 6px;
}

/* Kleiner noch straffer auf sehr schmalen Screens */
@media (max-width: 420px){
  :root{ --pad: 8px; --navW: clamp(44px, 12vw, 64px); --metaH: clamp(28px, 6vh, 56px); }
}
/* ===== Slide: Werkzeugleiste am unteren Bildrand ===== */
.slide-tools{
  position: absolute;
  left: 0; right: 0;
  bottom: 0;                 /* am Bildrand verankert */
  z-index: 3;                /* über der Bildfläche */
  display: flex;
  justify-content: center;
  padding:
    8px
    calc(env(safe-area-inset-right,0px) + 8px)
    calc(env(safe-area-inset-bottom,0px) + 8px)
    calc(env(safe-area-inset-left,0px) + 8px);
  pointer-events: none;      /* nur der innere Container klickbar */
}

.slide-tools-inner{
  pointer-events: auto;
  display: flex; gap: 10px;
  padding: 6px 8px;
  background: rgba(245, 246, 248, 0.692);   /* weißlich-grau, leicht transparent */
  border: 1px solid rgba(0,0,0,.10);
  border-radius: 14px;
  box-shadow: 0 6px 20px rgba(0,0,0,.20);
  backdrop-filter: saturate(1.1);
}

.slide-tools-inner button{
  appearance: none;
  background: transparent;
  border: 0;
  color: #0b1020;
  font: inherit;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 12px;
  cursor: pointer;
  font-size: clamp(14px, 2.8vw, 16px);
}

.slide-tools-inner button:hover{ background: rgba(0,0,0,.06); }
.slide-tools-inner button:focus-visible{
  outline: 2px solid rgba(40,80,200,.5);
  outline-offset: 2px;
}

/* Labels auf sehr kleinen Screens ausblenden */
.slide-tools-inner .label{ display: inline; }
@media (max-width: 420px){
  .slide-tools-inner .label{ display: none; }
}

/* === Info-Karte im Arbeitsblatt-Stil === */
.slide-content .info-card{
  background: rgba(152, 251, 152, 0.25);
  border: 1px solid #90c290;
  border-radius: 10px;
  padding: 14px 16px;
  margin: 10px 0 14px;

  display: grid;
  grid-template-columns: 1fr auto;         /* Text links, Illustration rechts */
  grid-template-areas:
    "header header"
    "content illustration";                 /* genau: Bild neben Text, unter der Überschrift */
  align-items: start;
  gap: 14px;
}
.slide-content .info-card header{ grid-area: header; }
.slide-content .info-card .info-content{ grid-area: content; }
.slide-content .info-card .info-illustration{ grid-area: illustration; align-self: start; }


.slide-content .info-card header h2{
  margin: 0 0 6px;
  color: #eff4ef;
  font-size: 1.1rem;
}

.slide-content .info-content p{
  margin: .55em 0;
  line-height: 1.45;
}

.slide-content .info-content .question{
  margin-top: .9em;
  font-weight: 700;
  color: #eff4ef;
}

.slide-content .info-illustration img{
  width: 110px;       /* Größe der Figur rechts */
  height: auto;
  display: block;
}

@media (max-width: 640px){
  .slide-content .info-card{
    grid-template-columns: 1fr;
    grid-template-areas:
      "header"
      "illustration"   /* Grafik direkt unter der Überschrift */
      "content";       /* Text darunter */
    text-wrap: pretty;
  }
  .slide-content .info-illustration{ justify-self: end; }
}

/* === VIDEO / COMING SOON === */
.video-wrap {
  position: relative;
  width: 100%;
  max-width: 100%;
  aspect-ratio: 16 / 9; /* responsive */
  background: #000;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--shadow);
}
.video-wrap iframe,
.video-wrap video {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  border: 0;
}

.coming-soon {
  display: grid;
  place-items: center;
  min-height: 220px;
  padding: 24px;
  border-radius: 12px;
  background: repeating-linear-gradient(
    45deg,
    rgba(255,255,255,.06) 0 12px,
    rgba(255,255,255,.03) 12px 24px
  );
  color: var(--muted);
  font-weight: 700;
  letter-spacing: .06em;
  text-transform: uppercase;
  box-shadow: var(--shadow);
}
.coming-soon span { opacity: .9; font-size: 18px; }
/* === Start-Toolbar: Mini-Version der Slide-Werkzeugleiste === */
.toolbar .slide-tools.slide-tools--mini {
  position: static; /* kein Overlay */
  inset: auto;
  background: transparent;
  box-shadow: none;
  padding: 0;
  margin: 0 0 8px 0; /* kleiner Abstand nach unten, wenn gewünscht */
}
.toolbar .slide-tools.slide-tools--mini .slide-tools-inner {
  justify-content: flex-start;
  gap: 8px;
}

/* === Fullscreen-Video-Modus in der Slide (neu) === */
#slide.video-mode {
  position: fixed;            /* über alles legen */
  inset: 0;
  width: 100vw;
  height: 100vh;
  background: #000;
  display: grid;
  grid-template-columns: 1fr !important; /* EIN Spalte */
  grid-template-rows: 1fr !important;    /* EINE Zeile */
  padding: 0 !important;
  margin: 0 !important;
  overflow: hidden;           /* nichts herausragen lassen */
  z-index: 9999;
}
/* Im Videomodus nur den Home-Button zeigen */
#slide.video-mode .slide-tools .tool-btn:not(#backBtn),
#slide.video-mode .slide-tools .linksBtn {
  display: none !important;
}


/* alles außer Video ausblenden */
#slide.video-mode #slideImg,
#slide.video-mode .slide-header,
#slide.video-mode #slideMeta,
#slide.video-mode #nextBgBtn,
#slide.video-mode .introBtn {  /* Video-Button selbst ausblenden */
  display: none !important;
}

/* rechte Content-Spalte zum Vollflächen-Bereich machen */
#slide.video-mode .slide-content,
#slide.video-mode #slideDesc {
  grid-column: 1 / -1 !important;
  grid-row: 1 / -1 !important;
  width: 100vw !important;
  height: 100vh !important;
  padding: 0 !important;
  margin: 0 !important;
  border: 0 !important;
  background: #000 !important;
}

/* das eigentliche Video auf die ganze Fläche legen */
#slide.video-mode .video-wrap {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  border-radius: 0 !important;
  box-shadow: none !important;
}
#slide.video-mode .video-wrap iframe,
#slide.video-mode .video-wrap video {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  border: 0;
  display: block;
}

/* nur der Home-Button bleibt sichtbar – oben links "schwebend" */
#slide.video-mode .slide-tools {
  position: fixed;
  top: 16px;
  left: 16px;
  right: auto;
  bottom: auto;
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
}
#slide.video-mode #backBtn {
backdrop-filter: none; /* kein extra Blur */
background: transparent; /* Hintergrund kommt aus .tool-icon */
border-radius: 12px; /* Standard wie tool-btn */
box-shadow: none; /* kein Extra-Schatten */
}


#slide.video-mode #backBtn .tool-icon {
/* ganz normales 3D-Design erzwingen */
background: linear-gradient(to bottom, #ffffff, #e0e0e0);
box-shadow:
inset 0 2px 2px rgba(255,255,255,0.9),
inset 0 -2px 2px rgba(0,0,0,0.15),
0 3px 6px rgba(0,0,0,0.25);
}

#slide.video-mode #backBtn .label {
  /* Wenn du nur das Icon willst, Zeile aktivieren: */
  /* display: none; */
}
html.no-scroll, body.no-scroll { overflow: hidden !important; }
/* === Blocksatz für Infotexte === */
.slide-content .info-card .info-content,
#slideDesc .info-content {
  text-align: justify;        /* Blocksatz */
  text-align-last: left;      /* letzte Zeile linksbündig */
  text-justify: inter-word;   /* bessere Wortabstände (unterstützte Browser) */
  hyphens: auto;              /* automatische Silbentrennung */
  -webkit-hyphens: auto;
  -ms-hyphens: auto;
}

/* Falls dein Text direkt als <p>/<li> in #slideDesc steht: */
#slideDesc p, 
#slideDesc li {
  text-align: justify;
  text-align-last: left;
  hyphens: auto;
  -webkit-hyphens: auto;
  -ms-hyphens: auto;
}

/* Überschriften/Labels NICHT im Blocksatz */
.slide-content .info-card header,
.slide-content .info-card header * {
  text-align: start;
  hyphens: manual;
}
/* === mobile: Info nicht von fixer Toolbar überdecken === */
:root{
  --tools-h: 60px;                    /* Default – wird per JS live gemessen */
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --tools-gap: 10px;                  /* kleiner Luftspalt über der Leiste */
}

/* Nur wenn Slide offen und NICHT im Video-Modus: unten Platz lassen */
#slide.open:not(.video-mode) .slide-content,
#slide.open:not(.video-mode) #slideDesc{
  padding-bottom: calc(var(--tools-h) + var(--safe-bottom) + var(--tools-gap));
  overflow: auto;                     /* falls noch nicht gesetzt */
}

/* Optional: kleinste Screens – etwas mehr Luft */
@media (max-width: 480px){
  #slide.open:not(.video-mode) .slide-content,
  #slide.open:not(.video-mode) #slideDesc{
    padding-bottom: calc(var(--tools-h) + var(--safe-bottom) + 16px);
  }
}

.slide-tools-inner .linksBtn,
.slide-tools.slide-tools--home .linksBtn{
background: transparent; /* übernimmt Standard .tool-btn + .tool-icon */
border: 0;
padding: 0;
}


/* Label ausblenden, wenn die Leisten nur Icons zeigen sollen */
.slide-tools .linksBtn .label{ display:none; }

/* Variante der runden Scheibe: komplett rot mit „i“ */
.i3d {
  width: 1.2em;
  height: 1.2em;
  border-radius: 50%;
  display: inline-grid;
  place-items: center;

  background: radial-gradient(120% 120% at 30% 28%,
             #ff7a7a 0%, #ff3b3b 35%, #d41313 65%, #8c0b0b 100%);
  box-shadow:
    inset 0 2px 2px rgba(255,255,255,.35),
    inset 0 -2px 4px rgba(0,0,0,.35);
}

.i3d::before {
  content: "i";
  color:#fff;
  font-weight: 800;
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Arial;
  font-size: 0.9em;
  line-height: 1;
  text-shadow: 0 1px 0 rgba(0,0,0,.35), 0 0 2px rgba(255,255,255,.2);
}



/* Hover/Active – wie bei den anderen Buttons */
.slide-tools-inner .linksBtn:hover,
.slide-tools.slide-tools--home .linksBtn:hover{
  box-shadow:
    0 10px 22px rgba(0,0,0,.26),
    inset 0 1px 0 rgba(255,255,255,.75);
}
.slide-tools-inner .linksBtn:active,
.slide-tools.slide-tools--home .linksBtn:active{
  transform: translateY(1px);
}

/* === Einheitliches Knopf-Design === */
.tool-btn{
appearance:none; background:transparent; border:0; color:#0b1020; font:inherit;
display:inline-flex; align-items:center; gap:8px; padding:10px 12px;
border-radius:12px; cursor:pointer; font-size: clamp(14px, 2.8vw, 16px);
}
.tool-btn:hover{ background: rgba(0,0,0,.06); }
.tool-btn:focus-visible{ outline: 2px solid rgba(40,80,200,.5); outline-offset: 2px; }


/* runde 3D-Scheibe für das Icon */
.tool-icon{
font-size: 2em; line-height:1; display:inline-flex; align-items:center; justify-content:center;
width: 2.2em; height: 2.2em; border-radius: 50%;
background: linear-gradient(to bottom, #ffffff, #e0e0e0);
box-shadow:
inset 0 2px 2px rgba(255,255,255,0.9),
inset 0 -2px 2px rgba(0,0,0,0.15),
0 3px 6px rgba(0,0,0,0.25);
}
.tool-btn:hover .tool-icon{
background: linear-gradient(to bottom, #fefefe, #d5d5d5);
box-shadow:
inset 0 2px 2px rgba(255,255,255,0.9),
inset 0 -2px 2px rgba(0,0,0,0.15),
0 4px 8px rgba(0,0,0,0.35);
}
.tool-btn:active .tool-icon{
background: linear-gradient(to bottom, #d5d5d5, #fefefe);
box-shadow:
inset 0 3px 4px rgba(0,0,0,0.25),
0 1px 2px rgba(0,0,0,0.15);
transform: translateY(1px);
}

/* === App-Page Modus (für die Info-Seite) === */
#slide.app-mode .slide-bg{ display:none !important; }
#slide.app-mode .slide-content{
background: transparent !important; /* kein Panel-Hintergrund */
border-left: 0 !important; /* Rahmen weg (Desktop) */
padding: 16px !important; /* dezente Luft */
}
/* === APP-MODUS: nur Back-Button oben links, keine untere Toolbar === */
#slide.app-mode .slide-tools {
  position: fixed;
  top: 16px;
  left: 16px;
  right: auto;
  bottom: auto;
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
}

/* ALLES außer Back-Button ausblenden */
#slide.app-mode .slide-tools .tool-btn:not(#backBtn),
#slide.app-mode .slide-tools .linksBtn {
  display: none !important;
}

/* Back-Button-Optik wie gewohnt (kein Sonder-Blur etc.) */
#slide.app-mode #backBtn{
  backdrop-filter: none;
  background: transparent;
  border-radius: 12px;
  box-shadow: none;
}
#slide.app-mode #backBtn .tool-icon{
  background: linear-gradient(to bottom, #ffffff, #e0e0e0);
  box-shadow:
    inset 0 2px 2px rgba(255,255,255,0.9),
    inset 0 -2px 2px rgba(0,0,0,0.15),
    0 3px 6px rgba(0,0,0,0.25);
}

/* Platz nach oben für den Back-Button im App-Modus */
#slide.app-mode .app-page {
  padding-top: 120px; /* ca. 60px Buttonhöhe + Abstand */
}

/* App-Page: Buttons im selben Format wie die übrigen Tool-Buttons */
/* ===== App-Page: vertikale Liste mit eigener "Mini-Toolbar" je Zeile ===== */


/* Eine Spalte: nur Liste */
#slide.app-mode .app-grid{
  display: block;
}

/* Vertikale Liste: Einträge füllen die Breite */
#slide.app-mode .app-list{
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: stretch;
}

/* Jede Zeile wirkt wie eine kleine Werkzeugleiste */
#slide.app-mode .app-row{
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 12px 14px;

  background: rgba(245, 246, 248, 0.72);
  border: 1px solid rgba(0,0,0,.10);
  border-radius: 14px;
  box-shadow: 0 6px 20px rgba(0,0,0,.20);
  backdrop-filter: saturate(1.1);
}

/* Der Button links: exakt wie deine Tool-Buttons */
#slide.app-mode .app-row .tool-btn{
  background: transparent;
  border: 0;
  padding: 8px 10px;
  border-radius: 12px;
}
#slide.app-mode .app-row .tool-btn:hover{ background: rgba(0,0,0,.06); }

#slide.app-mode .app-row .tool-btn .tool-icon{
  font-size: 2em;
  line-height: 1;
  width: 2.2em;
  height: 2.2em;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(to bottom, #ffffff, #e0e0e0);
  box-shadow:
    inset 0 2px 2px rgba(255,255,255,0.9),
    inset 0 -2px 2px rgba(0,0,0,0.15),
    0 3px 6px rgba(0,0,0,0.25);
}
#slide.app-mode .app-row .tool-btn:hover .tool-icon{
  background: linear-gradient(to bottom, #fefefe, #d5d5d5);
  box-shadow:
    inset 0 2px 2px rgba(255,255,255,0.9),
    inset 0 -2px 2px rgba(0,0,0,0.15),
    0 4px 8px rgba(0,0,0,0.35);
}
#slide.app-mode .app-row .tool-btn:active .tool-icon{
  background: linear-gradient(to bottom, #d5d5d5, #fefefe);
  box-shadow:
    inset 0 3px 4px rgba(0,0,0,0.25),
    0 1px 2px rgba(0,0,0,0.15);
  transform: translateY(1px);
}

/* Beschreibung steht immer rechts daneben */
#slide.app-mode .app-desc{
  color: var(--text);
  opacity: .95;
  font-size: 14px;
  line-height: 1.4;
}
#slide.app-mode .app-desc .title{
  display:inline-block;
  font-weight: 700;
  margin-right: .35rem;
}

/* Kleinere Screens: Button oben, Text darunter */
@media (max-width: 560px){
  #slide.app-mode .app-row{
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
}

/* --- Anker für den Tutorial-Button (oben links auf der Slide) --- */
#areaTutFloat {
  position: absolute;
  top: 12px;
  left: 120px;
  z-index: 1000;
  pointer-events: none; /* Container nimmt keine Klicks */
}

#areaTutFloat > .tool-btn {
  pointer-events: auto; /* nur der Button selbst klickbar */
}



.app-tile:hover { background: rgba(0,0,0,.06); } /* wie .tool-btn:hover */
.app-tile:focus-visible {
  outline: 2px solid rgba(40,80,200,.5);
  outline-offset: 2px;
}

/* die runde Scheibe genau wie sonst (Größe ggf. leicht größer fürs Grid) */
.app-tile .tool-icon {
  font-size: 2em;                  /* identisch zu deinen Leisten-Buttons */
  line-height: 1;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 2.2em;
  height: 2.2em;
  border-radius: 50%;
  background: linear-gradient(to bottom, #ffffff, #e0e0e0);
  box-shadow:
    inset 0 2px 2px rgba(255,255,255,0.9),
    inset 0 -2px 2px rgba(0,0,0,0.15),
    0 3px 6px rgba(0,0,0,0.25);
}
.app-tile:hover .tool-icon {
  background: linear-gradient(to bottom, #fefefe, #d5d5d5);
  box-shadow:
    inset 0 2px 2px rgba(255,255,255,0.9),
    inset 0 -2px 2px rgba(0,0,0,0.15),
    0 4px 8px rgba(0,0,0,0.35);
}
.app-tile:active .tool-icon {
  background: linear-gradient(to bottom, #d5d5d5, #fefefe);
  box-shadow:
    inset 0 3px 4px rgba(0,0,0,0.25),
    0 1px 2px rgba(0,0,0,0.15);
  transform: translateY(1px);
}

/* Label mittig, dezente Größe – wie bei dir üblich */
.app-tile .label {
  font-size: 14px;
  text-align: center;
}

/* Titel der App-Beschreibung */
.app-desc .title {
  color: #100f0f;     /* hier deine Wunschfarbe */
  font-weight: bold;  /* optional: hervorheben */
}

/* Fließtext der App-Beschreibung */
.app-desc span:not(.title) {
  color: #100f0f;     /* andere Farbe für den erklärenden Text */
  font-size: 0.9rem;  /* optional: kleinere Schrift */
}

.notes-page {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: flex-start;
  align-items: flex-start;
  padding: 20px;
  background: #fff; /* oder transparent, je nach Wunsch */
}

.notes-page .tool-btn {
  font-size: 2rem;
}

/* Platzhalter-Kacheln: kein Hover, kein Klick-Cursor */
.app-tile--disabled {
  pointer-events: none;
  opacity: .65;
  cursor: default;
}

.contact-form {
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-width: 500px;
  margin: 0 auto;
}

.contact-form input,
.contact-form textarea {
  padding: 8px;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  width: 100%;
}

.contact-form button {
  align-self: flex-start;
  margin-top: 10px;
}

/* NEU: Top-right Toolbar im Startbild */
.home-tools{
  position: absolute;
  top: 12px;
  right: 12px;
  z-index: 3;               /* über dem Bild/Overlay */
  pointer-events: none;     /* Container blockt nicht */
}
.home-tools .slide-tools-inner{
  pointer-events: auto;     /* nur die eigentliche Leiste ist klickbar */
}

/* Optional: auf sehr kleinen Screens Labels ausblenden (wie gewohnt) */
@media (max-width: 420px){
  .home-tools .label{ display: none; }
}

/* Tutorial: Overlay + Fokus + Tooltip */
.tut-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:9998; display:none; }
.tut-focus  { position:absolute; border:2px solid #fff; border-radius:12px;
  box-shadow:0 0 0 6px rgba(255,255,255,.25), 0 12px 30px rgba(0,0,0,.4);
  z-index:9999; display:none; pointer-events:none; transition:all .2s ease; }
.tut-tooltip{ position:absolute; max-width:min(90vw,360px); background:#10162a; color:#fff;
  border:1px solid rgba(255,255,255,.2); border-radius:12px; padding:12px 14px;
  z-index:10000; box-shadow:0 12px 28px rgba(0,0,0,.4); font-size:.95rem; line-height:1.35; display:none; }
.tut-actions { margin-top:10px; display:flex; gap:8px; }
.tut-btn{ appearance:none; background:#1f2b4d; color:#fff; border:1px solid rgba(255,255,255,.2);
  border-radius:10px; padding:8px 10px; cursor:pointer; font:inherit; }
.tut-btn:hover{ background:#273663; }
.tut-btn--skip::before{ content:"✖️ "; }
.tut-btn--next::after{ content:" ▶️"; }

/* Pfeil (blinkend) */
.tut-arrow{ position:absolute; width:34px; height:34px; z-index:10000; display:none; animation:tutBlink 1s ease-in-out infinite; }
.tut-arrow::before{ content:"⬇️"; font-size:28px; display:block; }
@keyframes tutBlink{ 0%,100%{ transform:translateY(0); opacity:.9; } 50%{ transform:translateY(6px); opacity:.3; } }


  </style>
</head>
<body>
  <div class="app card" role="application" aria-label="Interaktive Bild-Hotspots Lernspiel">
    <div class="header">
      <div style="display:flex; gap:12px; align-items:center;">
        <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M10.25 21v-6h3.5v6h5.25V12.5H21L12 3l-9 9.5h2.25V21z"/></svg>
        <div>
          <h1>Innenausbau Projekt - Stadtvilla Familie Müller</h1>
          <small></small>
        </div>
        <span class="badge" id="adminBadge">Admin aktiv</span>
        <button id="exitAdminBtn" class="admin-btn admin-only inline" title="Admin-Modus verlassen">Rolle wechseln</button>

      </div>
      <div class="right">
        <button id="adminBtn" class="admin-btn" aria-pressed="false" title="Admin ein/aus">🔒 Admin</button>
      </div>
    </div>

    <div class="wrap">
      <img id="baseImage" src="haus.png" alt="Abbildung eines Hauses" />
      <svg class="overlay" id="overlay" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true"></svg>
          <!-- NEU: Home-Infobar oben rechts im Bild -->
        <div class="home-tools" aria-label="Infoleiste">
      <div class="slide-tools-inner">
        <button class="linksBtn tool-btn" type="button" title="Infopage öffnen">
          <span class="tool-icon">
            <!-- nutzt deine bereits gestylte rote i-Scheibe -->
            <span class="i3d" aria-hidden="true"></span>
          </span>
          <span class="label">Info</span>
        </button>
      </div>
    </div>

    </div>

    <div class="toolbar">

              <label class="admin-only inline" style="display:inline-flex;gap:.5rem;align-items:center">
          <span>Schriftart:</span>
          <select id="fontSelect">
            <option value="system">System</option>
            <option value="inter" selected>Inter (Sans)</option>
            <option value="merri">Merriweather (Serif)</option>
          </select>
        </label>

                  <!-- Mini-Werkzeugleiste in der Start-Toolbar -->
      <div class="slide-tools slide-tools--mini">
        <div class="slide-tools-inner">
        <button class="introBtn tool-btn" type="button" title="Einstiegsvideo ansehen">
        <span class="tool-icon">🎬</span>
        <span class="label">Video</span>
        </button>
        </div>
      </div>

      <label class="admin-only inline"><input type="file" id="imgPicker" accept="image/*" />Eigenes Bild laden</label>
      <button id="toggleLabels" type="button" class="admin-only inline" aria-pressed="false">Labels an/aus</button>
      

      <button id="startMeasure" type="button" class="admin-only inline">Neuen Bereich aufnehmen</button>
      <div class="measure-group admin-only flex" id="measureGroup">
        <button id="undoPoint" type="button">Punkt zurück</button>
        <button id="savePoly" type="button" disabled>Fertig (speichern)</button>
        <button id="cancelMeasure" type="button">Abbrechen</button>
      </div>

      <select id="hotspotSelect" class="admin-only inline">
        <option value="">Bereich wählen…</option>
      </select>
      <div class="edit-group admin-only flex" id="editGroup" style="display:none; align-items:center; gap:8px;">
        <span id="editLabel">Bearbeite: –</span>
        <button id="renameBtn" type="button">Umbenennen</button>
        <button id="startEditBtn" type="button">Punkte bearbeiten</button>
        <button id="addPointBtn" type="button" disabled>Punkt hinzufügen</button>
        <button id="removePointBtn" type="button" disabled>Letzten Punkt entfernen</button>
        <button id="saveEditBtn" type="button" disabled>Änderungen speichern</button>
        <button id="cancelEditBtn" type="button" disabled>Abbrechen</button>
        <button id="deleteBtn" type="button">Löschen</button>
        <button id="shareLink" type="button">Teilen (URL kopieren)</button>
      </div>

      <div class="admin-only flex" id="zoomGroup" title="Zoom für Folie" style="align-items:center; gap:8px;">
        <span>Zoom</span>
        <input id="zoomSlider" type="range" min="1" max="5" step="0.1" value="2">
        <output id="zoomOut">2.0×</output>
      </div>

      <div class="admin-only flex" id="assetsGroup" style="align-items:center; gap:8px;">
        <span>Assets-Pfad</span>
        <input id="assetsBase" type="text" value="assets/areas" placeholder="assets/areas" />
        <button id="saveAssetsBase" type="button">Speichern</button>
      </div>

      <!-- Zentrale Daten → Export / Import / Server laden -->
      <div class="admin-only flex" id="dataGroup" style="align-items:center; gap:8px;">
        <button id="serverLoadBtn" type="button" title="hotspots.json vom Server laden">Vom Server laden</button>
        <button id="exportBtn" type="button" title="Hotspots als JSON exportieren">Hotspots exportieren</button>
        <label class="inline" title="Hotspots aus JSON importieren"><input type="file" id="importFile" accept="application/json" />Hotspots importieren</label>
        <span id="activeSetInfo" style="margin-left:auto; opacity:.8;"></span>
      </div>
    </div>

    <div id="storageWarn" class="hint warn" style="display:none"></div>

  </div>

  <!-- Neue FOLIE -->
  <section class="slide" id="slide" aria-live="polite" aria-modal="true" role="dialog">
    <div class="slide-bg">
      <img id="slideImg" alt="Bereichsbild" />
        </div>
      <div class="slide-tools" aria-label="Werkzeugleiste">
        <div class="slide-tools-inner">
              <button id="backBtn" class="tool-btn" aria-label="Zurück">
              <span class="tool-icon">🏠</span> <span class="label">Zurück</span>
              </button>
              <button id="nextBgBtn" class="tool-btn" aria-label="Bilder anzeigen" title="Bilder anzeigen">
              <span class="tool-icon">📸</span> <span class="label">Bilder</span>
              </button>
              <button class="introBtn tool-btn" type="button" title="Video zum Bereich ansehen">
              <span class="tool-icon">🎬</span>
              <span class="label">Video</span>
              </button>

           <button class="linksBtn tool-btn" type="button" title="Externe Links">
            <span class="tool-icon">
              <span class="i3d" aria-hidden="true"></span>
            </span>
            <span class="label">Links</span>
          </button>


        </div>
      </div>


    <article class="slide-content">
      <div class="meta" id="slideMeta"></div>
      <h2 id="slideTitle">Titel</h2>
      <div id="slideDesc">Beschreibung</div>
    </article>
  </section>
  <!-- Rollen-Dialog -->
  <div id="roleModal" class="role-modal" aria-modal="true" role="dialog">
    <div class="role-card" role="document" aria-labelledby="roleTitle">
      <h2 id="roleTitle">Bitte wähle eine Rolle aus.</h2>
      <p></p>
      <div class="role-actions">
      <button id="roleStudent" class="role-btn">Schüler</button>
      <button id="roleTeacher" class="role-btn">Lehrer</button>
      </div>
    </div>
  </div>

<!-- Lightbox / Slideshow -->
      <div id="lightbox" class="lightbox" aria-live="polite" aria-modal="true" role="dialog" style="display:none">
        <button class="lb-close" id="lbClose" aria-label="Schließen">✕</button>

        <button class="lb-nav lb-prev" id="lbPrev" aria-label="Vorheriges Bild">‹</button>
        <img id="lbImg" class="lb-img" alt="Slideshow Bild" />
        <button class="lb-nav lb-next" id="lbNext" aria-label="Nächstes Bild">›</button>

        <div class="lb-meta" id="lbMeta"></div>
      </div>
<!-- Tutorial Layer -->
      <div id="tutOverlay" class="tut-overlay" aria-hidden="true"></div>
      <div id="tutFocus"   class="tut-focus"   aria-hidden="true"></div>
      <div id="tutArrow"   class="tut-arrow"   aria-hidden="true"></div>
      <div id="tutTip"     class="tut-tooltip" role="dialog" aria-live="polite" aria-modal="false">
        <div id="tutText">—</div>
        <div class="tut-actions">
          <button id="tutSkip" class="tut-btn tut-btn--skip" type="button">Überspringen</button>
          <button id="tutNext" class="tut-btn tut-btn--next" type="button">Weiter</button>
        </div>
      </div>

  <script>
    //font
    const fontMap = {
        system: 'system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Arial, "Helvetica Neue", sans-serif',
        inter: '"Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", Arial, "Helvetica Neue", sans-serif',
        merri: '"Merriweather", Georgia, "Times New Roman", serif',
            };
            document.getElementById('fontSelect')?.addEventListener('change', (e)=>{
              const val = e.target.value;
              document.documentElement.style.setProperty('--font-body', fontMap[val]);
            });

    // ===== Utils =====
    const umlauts = { 'ä':'ae','ö':'oe','ü':'ue','ß':'ss' };
    function slugify(str){
      return String(str||'')
        .toLowerCase()
        .replace(/[äöüß]/g, m=>umlauts[m])
        .replace(/[^a-z0-9\s-]/g,'')
        .trim()
        .replace(/\s+/g,'-')
        .replace(/-+/g,'-');
    }
    function clamp(v, min, max){ return Math.min(max, Math.max(min, v)); }
    // Flächengewichteter Schwerpunkt für ein Polygon (x/y in Prozent)
    function polyCentroid(pts){
      let a = 0, cx = 0, cy = 0;
      const n = pts.length;
      if(n < 3) return { x: pts[0]?.x || 50, y: pts[0]?.y || 50 };
      for(let i=0; i<n; i++){
        const p = pts[i], q = pts[(i+1)%n];
        const cross = p.x*q.y - q.x*p.y;
        a += cross;
        cx += (p.x + q.x) * cross;
        cy += (p.y + q.y) * cross;
      }
      a = a * 0.5;
      if(Math.abs(a) < 1e-7){
        // degeneriert -> fallback: einfacher Mittelwert
        const mx = pts.reduce((s,p)=>s+p.x,0)/n;
        const my = pts.reduce((s,p)=>s+p.y,0)/n;
        return { x: mx, y: my };
      }
      cx = cx / (6*a);
      cy = cy / (6*a);
      return { x: cx, y: cy };
    }
    // Punkt-in-Polygon (Raycasting)
function pointInPolygon(pt, pts){
  let inside = false;
  for(let i=0, j=pts.length-1; i<pts.length; j=i++){
    const xi = pts[i].x, yi = pts[i].y;
    const xj = pts[j].x, yj = pts[j].y;
    const intersect = ((yi > pt.y) !== (yj > pt.y)) &&
      (pt.x < ( (xj - xi) * (pt.y - yi) / (yj - yi) + xi ));
    if(intersect) inside = !inside;
  }
  return inside;
}

// Abstand Punkt–Segment (für "max Abstand zu Kanten")
function distPointToSegSq(p, a, b){
  let x = a.x, y = a.y;
  let dx = b.x - a.x, dy = b.y - a.y;
  if(dx !== 0 || dy !== 0){
    const t = ((p.x - x)*dx + (p.y - y)*dy) / (dx*dx + dy*dy);
    if(t > 1){ x = b.x; y = b.y; }
    else if(t > 0){ x += dx*t; y += dy*t; }
  }
  const ddx = p.x - x, ddy = p.y - y;
  return ddx*ddx + ddy*ddy;
}

// "Sicherer" Punkt im Polygon: Schwerpunkt, sonst grobe Gitter-Suche im BBox
function insidePointFor(pts){
  // 1) Versuch: Flächen-Schwerpunkt
  let c = polyCentroid(pts);
  if(pointInPolygon(c, pts)) return c;

  // 2) Fallback: Gitter-Suche im Bounding-Box, wähle Punkt mit max. Kanten-Abstand
  let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
  for(const p of pts){ if(p.x<minX) minX=p.x; if(p.x>maxX) maxX=p.x; if(p.y<minY) minY=p.y; if(p.y>maxY) maxY=p.y; }
  const steps = 24; // 24x24 = 576 Checks -> schnell genug
  let best = null, bestD2 = -1;
  for(let iy=0; iy<=steps; iy++){
    for(let ix=0; ix<=steps; ix++){
      const x = minX + (maxX - minX) * (ix/steps);
      const y = minY + (maxY - minY) * (iy/steps);
      const pt = {x,y};
      if(!pointInPolygon(pt, pts)) continue;
      // min. Abstand zu allen Kanten berechnen
      let minD2 = Infinity;
      for(let i=0, j=pts.length-1; i<pts.length; j=i++){
        const d2 = distPointToSegSq(pt, pts[j], pts[i]);
        if(d2 < minD2) minD2 = d2;
      }
      if(minD2 > bestD2){ bestD2 = minD2; best = pt; }
    }
  }

  // 3) Falls nichts gefunden (extrem schmal): nimm einfach den Vertex-Mittelwert
  if(!best){
    const x = pts.reduce((s,p)=>s+p.x,0)/pts.length;
    const y = pts.reduce((s,p)=>s+p.y,0)/pts.length;
    best = {x,y};
  }
  // Begrenzen auf [0..100], nur zur Sicherheit
  return { x: clamp(best.x, 0, 100), y: clamp(best.y, 0, 100) };
}
  // === Toolbar-Höhe messen und als CSS-Variable setzen ===
  (function setupToolsHeightOnce(){
  // Schutz: keine doppelte Initialisierung
  if (window.__toolsHeightSetup) return;
  window.__toolsHeightSetup = true;
function updateToolsHeight(){
  const tools = document.querySelector('#slide .slide-tools');
  if(!tools) return;
  const h = Math.ceil(tools.getBoundingClientRect().height);
  document.documentElement.style.setProperty('--tools-h', h + 'px');
}

// beim Laden + Fenster-/Viewport-Änderungen updaten
window.addEventListener('load', updateToolsHeight);
window.addEventListener('resize', updateToolsHeight);
window.addEventListener('orientationchange', updateToolsHeight);
if (window.visualViewport){
  visualViewport.addEventListener('resize', updateToolsHeight);
}

// wenn sich #slide-Klassen ändern (z. B. open/video-mode), neu messen
(new MutationObserver(updateToolsHeight)).observe(
  document.getElementById('slide'),
  { attributes: true, attributeFilter: ['class'] }
);

// OPTIONAL: nach dem Öffnen einer Slide/Wechsel der Inhalte manuell aufrufen
// z.B. in deiner openArea(...) oder nachdem du #slideDesc befüllst:
// updateToolsHeight();

// Ein Initial-Messungstrigger schadet nicht:
  if (document.readyState !== 'loading') {
    requestAnimationFrame(updateToolsHeight);
  } else {
    document.addEventListener('DOMContentLoaded', updateToolsHeight, { once: true });
  }
})();


    function canUseLocalStorage(){
      try{ const k='__t'; localStorage.setItem(k,'1'); localStorage.removeItem(k); return true; }catch{ return false; }
    }
    function qs(name){ const u=new URL(location.href); return u.searchParams.get(name); }

    // ===== Inhalte (nur im Code) =====
    const contents = {
              eg: {
                title: 'Erdgeschoss',
                html: `
                  <section class="info-card">
                    <header>
                       <p><h3>Situation 1 – Der abtrennbare Schlafbereich &nbsp;&nbsp;&nbsp; <h3></p>
                        <p><h2>Anforderungsbereich &nbsp;&nbsp;&nbsp; ⭐⭐⭐ </p> </h2>
                    </header>

                    <div class="info-content">
                      <p>
                        Im Erdgeschoss der Stadtvilla ist alles auf Ruhe und Rückzug abgestimmt: Schlafzimmer und ein sehr großzügiges Bad bilden eine eigene Einheit hinter einer durchgehenden Wand, getrennt vom übrigen Haus und doch hat jeder Raum seinen eigenen Zugang.
                      </p>
                      <p>
                        Weil es das einzige Bad im Haus ist, soll der Durchgang zwischen Schlaf- und Nassbereich je nach Situation offen oder geschlossen sein ohne eine feste neue Wand zu errichten. 	Familie Müller wünscht sich dafür eine kreative, variable Lösung, am besten eine Tür, die den Übergang elegant verschwinden lässt.
                      </p>
                      <p>
                       Die Innenseite der Trennwand soll eine hölzerne Wandverkleidung erhalten: warm, ruhig, wohnlich – ganz nach Herr Müllers Liebe zu Holz. In diese Verkleidung müssen alle Abschlüsse nahtlos integriert werden: die Tür zum Schlafzimmer, die Tür zum Bad und die variable Trennung dazwischen. Nichts soll hervorstehen; Fugenbild, Linien und Proportionen geben den Ton an. Auf der Flurseite bleibt die Wand ohne Verkleidung – klar und zurückhaltend. 
                        </p>
                      <h3 class="question">Nun stellt sich die Frage:</h3>
                      <p>
                        Wie gehen wir am besten vor, um unser Ziel zu erreichen?
                      </p>
                    </div>

                    <aside class="info-illustration">
                      <img src="assets/ui/handwerker.png" alt="Illustration: Handwerker">
                    </aside>
                  </section>
                `
              },

            og: {
                title: '1. Obergeschoss',
                html: `
                  <section class="info-card">
                    <header>
                      <p><h3>Situation 2 – Die Bibliothek &nbsp;&nbsp;&nbsp; <h3></p>
                        <p><h2>Anforderungsbereich &nbsp;&nbsp;&nbsp; ⭐ </p> </h2>
                    </header>

                    <div class="info-content">
                      <p>
                       Oben, auf der Empore mit Blick in den Wohnraum, fällt das Nachmittagslicht auf eine lange, noch leere Außenwand. Genau hier wünschen sich die Müllers ihre kleine Bibliothek ein ruhiger Ort zwischen Arbeitszimmer und Galerie.
                      </p>
                      <p>
                        Beim Aufmaß zeigt sich der Patzer: Für das Arbeitszimmer wurden versehentlich zwei Türöffnungen hergestellt. Die Lösung soll beides vereinen: Die Emporen-Außenwand wird zu einem durchgehenden Bücherregal, das den Raum ordnet und Gewicht bekommt. Der falsch erstellte Durchgang wird von der Arbeitszimmerseite mit einem Regal geschlossen als funktionale Einbautiefe nach innen. Der korrekte Zugang bleibt bestehen, die Tür wird unsichtbar in das Regalsystem integriert: Linien laufen weiter, Fugen greifen durch, Griffe verschwinden im Raster.
                      </p>
                      <p>
                      Die Inspiration liefert wieder das Haus Rühlstraße klar, ruhig, präzise. Material und Design liegen zunächst bei uns: warmes Holz oder hell und fein? Offene Fächer, integrierte Zargen, verdeckte Bänder alles so, dass Türblatt und Regal als eine Fläche wirken. Bevor es losgeht, sichern wir die Varianten mit den Bauherren ab. 
                      </p>
                      <h3 class="question">Nun stellt sich die Frage:</h3>
                      <p>
                        Wie gehen wir am besten vor, um unser Ziel zu erreichen?
                      </p>
                    </div>

                    <aside class="info-illustration">
                      <img src="assets/ui/handwerker.png" alt="Illustration: Handwerker">
                    </aside>
                  </section>
                `
              },
            pool: {
                title: 'Poolhaus',
                html: `
                  <section class="info-card">
                    <header>
                        <p><h3>Situation 3 – Der Saunaumbau  <h3></p>
                        <p><h2>Anforderungsbereich &nbsp;&nbsp;&nbsp; ⭐⭐ </p> </h2>
                    </header>

                    <div class="info-content">
                      <p>
                        Am Rand des Gartens liegt das Poolhaus: bisher ein nüchterner Funktionsraum mit Dusche, WC und Regalen fürs Zubehör. Jetzt soll daraus ein echter Rückzugsort werden. Vor allem Frau Müller wünscht sich eine Sauna, die den Wellnessbereich komplettiert. 
                      </p>
                      <p>
                        Unser Auftrag: Den Raum durch eine Trennwand so teilen, dass der rechte Gebäudeteil zur Sauna umgebaut werden kann; der separate Außenzugang ist bereits vorhanden und bleibt in Nutzung. Über der künftigen Sauna soll die Decke zusätzlich um ca. 20 cm abgehängt werden, um Platz für die Lüftungsanlage (Zuluft/Abluft, Revisionsmöglichkeit) zu schaffen. Der gesamte Saunabereich wird energetisch gedämmt, dabei sind sowohl die neu zu errichtende Trennwand als auch die Außenwände zu berücksichtigen. 	
                      </p>
                      <p>
                        Gewünscht ist eine klassische Sauna mit vollflächiger Holzverkleidung rundum. Das Design soll ruhig, hochwertig und stimmig zum Haus gestaltet werden. Die Decke ist dem entsprechend passend auszuführen. Materialwahl und Design liegen bei uns; wir bereiten Varianten vor und klären die Auswahl vor Ausführung mit den Bauherren.  
                      </p>
                        <h3 class="question">Nun stellt sich die Frage:</h3>
                      <p>
                        Wie gehen wir am besten vor um unser Ziel zu erreichen?
                      </p>
                    </div>

                    <aside class="info-illustration">
                      <img src="assets/ui/handwerker.png" alt="Illustration: Handwerker">
                    </aside>
                  </section>
                `
              },
      keller: {
                title: 'Keller',
                html: `
                  <section class="info-card">
                    <header>
                      <p><h3>Situation 4 – Türmontage im Keller  <h3></p>
                      <p><h2>Anforderungsbereich &nbsp;&nbsp;&nbsp; ⭐⭐⭐⭐ </p> </h2>
                    </header>

                    <div class="info-content">
                      <p>
                        Das wird der UB -> Einzelsituation mit allen Schülern evtl mini Stationenarbeit
                      </p>
                      <p>
                      </p>
                      <p>
                      </p>
                      <h3 class="question">Nun stellt sich die Frage:</h3>
                      <p>
                        Wie gehen wir vor um unser Ziel zu erreichen?
                      </p>
                    </div>

                    <aside class="info-illustration">
                      <img src="assets/ui/handwerker.png" alt="Illustration: Handwerker">
                    </aside>
                  </section>
                `
              },
      
      // weitere Bereiche hier ergänzen: fenster: {...}, tuer: {...}, fassade: {...}
    };

    // ===== Persistente Schlüssel =====
    const LS_KEYS = { hotspots: 'hotspots_v1', zoom: 'zoom_v1', assets: 'assets_base_v1' };

    // ===== Hotspots – initial aus localStorage =====
    let hotspots = loadHotspots();


    // Labels standardmäßig AUS
    let labelsOn = false;
    let measureMode = false;
    let draftPoints = [];
    let tempLayer; // Vorschau-Layer (Mess)

    // Editier-Status
    let selectedIndex = -1;
    let editing = false;
    let editLayer = null;
    let editPoints = [];
    let draggingIdx = -1;
    let addingPoint = false;

    // Admin-Status (Session) & PIN
    const ADMIN_PIN = 'test';
    let isAdmin = sessionStorage.getItem('is_admin') === 'true';

    // Globale Zoom-Kennzahl (über Slider änderbar)
    let zoom = loadZoom();

    const END_EXT = 'png'; // falls deine Dateien .png sind -> 'png'
    let lastAreaSlug = null; // zuletzt geöffneter Bereich
    const VIDEO_FROM_HOME = "__home__";
    let videoOrigin = null;
    let videoOriginSlug = null;
    const APP_FROM_HOME = "__home__";
    let appOrigin = null; // "__home__" oder ein Bereichs-Slug (z. B. "eg")


    const videos = {
  default: "assets/videos/intro.mp4", // Startseite
  "poolhaus": "",
  "eg": "",
  "og": "" // leer => „Coming Soon“
};

    // Assets
    const assetsBaseInput = document.getElementById('assetsBase');
    const assetsBaseBtn = document.getElementById('saveAssetsBase');
    let assetsBase = loadAssetsBase();
    assetsBaseInput.value = assetsBase;

    // Zentrale Daten (Server/Repo)
    const setParam = qs('set');
    const activeSetName = setParam ? slugify(setParam) : 'default';
    const centralPath = activeSetName === 'default' ? 'data/hotspots.json' : `data/hotspots-${activeSetName}.json`;

    // DOM Refs
    const overlay = document.getElementById('overlay');
    const measureGroup = document.getElementById('measureGroup');
    const startBtn = document.getElementById('startMeasure');
    const undoBtn = document.getElementById('undoPoint');
    const saveBtn = document.getElementById('savePoly');
    const cancelBtn = document.getElementById('cancelMeasure');

    const hotspotSelect = document.getElementById('hotspotSelect');
    const editGroup = document.getElementById('editGroup');
    const editLabel = document.getElementById('editLabel');
    const renameBtn = document.getElementById('renameBtn');
    const startEditBtn = document.getElementById('startEditBtn');
    const addPointBtn = document.getElementById('addPointBtn');
    const removePointBtn = document.getElementById('removePointBtn');
    const saveEditBtn = document.getElementById('saveEditBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const deleteBtn = document.getElementById('deleteBtn');

          // --- Intro/Hintergrund Status ---
      const INTRO_SEEN_KEY = 'intro_seen_v1';
      const baseImageEl = document.getElementById('baseImage');

      // Passe ggf. die Dateinamen/Endungen an:
      const HOME_BG_DEFAULT = 'haus.png';
      const HOME_BG_AFTER_CANDIDATES = ['haus_after.png', 'haus_after.webp', 'haus_after.jpg'];

      function setHomeBgDefault(){
        if (baseImageEl) baseImageEl.src = HOME_BG_DEFAULT;
      }
      function setHomeBgAfter(){
        if (!baseImageEl) return;
        // Nimm die erste existierende Datei (png/webp/jpg)
        let i = 0;
        const img = new Image();
        const next = ()=>{
          if (i >= HOME_BG_AFTER_CANDIDATES.length) return;
          const url = HOME_BG_AFTER_CANDIDATES[i++];
          img.onload = ()=>{ baseImageEl.src = url; };
          img.onerror = next;
          img.src = url;
        };
        next();
      }

    // Slide elements
    const slide = document.getElementById('slide');
    const slideImg = document.getElementById('slideImg');
    const slideTitle = document.getElementById('slideTitle');
    const slideDesc = document.getElementById('slideDesc');
    const slideMeta = document.getElementById('slideMeta');
    const backBtn = document.getElementById('backBtn');
    let nextBgBtn = document.getElementById('nextBgBtn');

    // === VIDEO: Hilfsfunktionen ===
function toYouTubeEmbed(url){
  try{
    const u = new URL(url);
    if(u.hostname.includes("youtu.be")) return "https://www.youtube.com/embed/" + u.pathname.slice(1);
    if(u.hostname.includes("youtube.com")){
      const id = u.searchParams.get("v");
      return id ? "https://www.youtube.com/embed/" + id : url;
    }
  }catch(e){}
  return url;
}

function resolveContextVideoSrc(){
  const fromHome = !slide.classList.contains("open"); // Slide noch zu? => Startseite

  if (fromHome) {
    // Startseite -> Intro (falls gesetzt), sonst Coming Soon
    return videos.default || "";
  }

  // Wir sind in einer Bereichs-Slide:
  // Nur liefern, wenn ein Eintrag für den Slug existiert – KEIN Default-Fallback!
  if (lastAreaSlug && Object.prototype.hasOwnProperty.call(videos, lastAreaSlug)) {
    return videos[lastAreaSlug] || ""; // leer -> Coming Soon
  }

  // kein Eintrag -> Coming Soon
  return "";
}


function rememberDesc(){
  if (!slideDesc.dataset.prev) slideDesc.dataset.prev = slideDesc.innerHTML;
}
function restoreDesc(){
  if (slideDesc.dataset.prev != null){
    slideDesc.innerHTML = slideDesc.dataset.prev;
    delete slideDesc.dataset.prev;
  }
}

function cleanupVideo(){
  // Medien stoppen
  slideDesc.querySelectorAll("video").forEach(v=>{ try{ v.pause(); }catch(e){} });
  slideDesc.querySelectorAll("iframe").forEach(f=>{ try{ f.src = f.src; }catch(e){} });
  // Falls Intro von der Startseite lief und schon weit genug geschaut wurde:
  try{
    if (introPlaybackFromHome && currentVideoEl && currentVideoEl.duration){
      const ratio = currentVideoEl.currentTime / currentVideoEl.duration;
      if (ratio >= 0.85) {
        localStorage.setItem(INTRO_SEEN_KEY,'1');
        introSeen = true;
        setHomeBgAfter();
      }
    }
  }catch(e){/* ignore */}
  introPlaybackFromHome = false;
  currentVideoEl = null;

  // Inhalt zurücksetzen
  restoreDesc();

  // Bild wieder zeigen
  if (slideImg) slideImg.style.display = "";

  // WICHTIG: Videomodus verlassen
  slide.classList.remove("video-mode");
  document.documentElement.classList.remove("no-scroll");
  document.body.classList.remove("no-scroll");

}

function cleanupApp(){
  // Inhalt zurücksetzen
  restoreDesc();
  // Bild wieder zeigen
  if (slideImg) slideImg.style.display = "";
  // App-Modus aus
  slide.classList.remove("app-mode");
}



function openContextVideo(){
  const src = resolveContextVideoSrc();
  // merken, ob das Video von einer Slide (Slug) kommt oder von der Startseite
  // Herkunft sauber bestimmen: Ist die Slide gerade geschlossen? -> Startseite
  const openedFromHome = !slide.classList.contains("open");
  videoOrigin = openedFromHome ? VIDEO_FROM_HOME : (lastAreaSlug || VIDEO_FROM_HOME);

  // Slide öffnen (auf Startseite ist sie noch zu)
  slide.classList.add("open");
  // >>> Fullscreen-Video-Modus aktivieren
  slide.classList.add("video-mode");
  document.documentElement.classList.add("no-scroll");
  document.body.classList.add("no-scroll");

  if (videoOrigin === VIDEO_FROM_HOME){
    slideTitle.textContent = "";
    slideMeta.textContent = "";
  }

  // Bild ausblenden, vorherige Inhalte merken
  if (slideImg) slideImg.style.display = "none";
  rememberDesc();

  if (!src){
    // Kein Video hinterlegt -> Coming Soon (trotz Fullscreen)
    slideDesc.innerHTML = `<div class="video-wrap"><div class="coming-soon"><span>Coming&nbsp;Soon</span></div></div>`;
    return;
  }

  const isYT = /youtu\.be|youtube\.com/.test(src);
  if (isYT){
    const embed = toYouTubeEmbed(src);
    slideDesc.innerHTML = `
      <div class="video-wrap">
        <iframe src="${embed}"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen></iframe>
      </div>
    `;
  } else {
    slideDesc.innerHTML = `
      <div class="video-wrap">
        <video src="${src}" controls playsinline preload="metadata"></video>
      </div>
    `;
          const v = slideDesc.querySelector('video');
      currentVideoEl = v;
      introPlaybackFromHome = (videoOrigin === VIDEO_FROM_HOME);

      // Helper: einmalig markieren + Bild tauschen
      function markIntroWatched(){
        if (introSeen) return;
        introSeen = true;
        localStorage.setItem(INTRO_SEEN_KEY,'1'); // <— vereinheitlicht
        setHomeBgAfter();
        }


      // 1) „echtes“ Ende
      v.addEventListener('ended', ()=>{ if (introPlaybackFromHome) markIntroWatched(); }, { once:true });

      // 2) Falls früh geschlossen: ab 85 % als „gesehen“ werten
      let flagged = false;
      v.addEventListener('timeupdate', function onTU(){
        if (flagged || !introPlaybackFromHome) return;
        if (v.duration && v.currentTime / v.duration >= 0.85){
          flagged = true;
          v.removeEventListener('timeupdate', onTU);
          markIntroWatched();
  }
});

  }
}


// === VIDEO: Buttons (Startseite + Folie) anschließen ===
document.querySelectorAll(".introBtn").forEach(btn=>{
  btn.addEventListener("click", openContextVideo);
});

// Back-Button: Video- oder App-Modus korrekt verlassen
backBtn.addEventListener("click", function(e){
  const inVideo = slide.classList.contains("video-mode");
  const inApp   = slide.classList.contains("app-mode");

  if (!inVideo && !inApp) return; // normales Verhalten weiterlaufen lassen

  // --- Videomodus ---
  if (inVideo){
    if (videoOrigin === VIDEO_FROM_HOME){
      cleanupVideo();
      localStorage.setItem(INTRO_SEEN_KEY,'1');
      setHomeBgAfter();
      videoOrigin = null;
      return;
    }
    // Video kam aus einer Bereichs-Slide -> nur Vollbild beenden
    e.preventDefault();
    e.stopImmediatePropagation?.();
    cleanupVideo();
    videoOrigin = null;
    return;
  }

  // --- App-Modus ---
  if (inApp){
    e.preventDefault();
    e.stopImmediatePropagation?.();

    if (appOrigin === APP_FROM_HOME){
      // App kam von Startseite -> App aufräumen & Slide schließen
      cleanupApp();
      appOrigin = null;
      slide.classList.remove("open");
    } else {
      // App kam aus Bereichs-Slide -> App-Modus beenden, Slide bleibt
      cleanupApp();
      appOrigin = null;
    }
  }
}, true); // capture=true

    // Header/Admin
    const adminBtn = document.getElementById('adminBtn');
    const adminBadge = document.getElementById('adminBadge');

    //Admin Exit
    const exitAdminBtn = document.getElementById('exitAdminBtn'); // NEU

    // Data UI
    const serverLoadBtn = document.getElementById('serverLoadBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importFile = document.getElementById('importFile');
    const activeSetInfo = document.getElementById('activeSetInfo');
    activeSetInfo.textContent = `Aktives Set: ${activeSetName} (${centralPath})`;

    // Zoom UI
    const zoomSlider = document.getElementById('zoomSlider');
    const zoomOut = document.getElementById('zoomOut');
    if(zoomSlider){
      zoomSlider.value = String(zoom);
      zoomOut.textContent = `${zoom.toFixed(1)}×`;
      zoomSlider.addEventListener('input', ()=>{ 
        zoom = parseFloat(zoomSlider.value); 
        zoomOut.textContent = `${zoom.toFixed(1)}×`; 
        saveZoom();
      });
    }

    backBtn.addEventListener('click', ()=> closeSlide());

    // ===== Admin Login/Logout =====
    adminBtn.addEventListener('click', ()=>{
      if(isAdmin){
        if(measureMode) toggleMeasure(false);
        if(editing) exitEditMode(false);
        isAdmin = false; sessionStorage.setItem('is_admin','false');
        applyAdminUI();
        return;
      }
      const pin = prompt('Admin-PIN eingeben:');
      if(pin === ADMIN_PIN){
        isAdmin = true; sessionStorage.setItem('is_admin','true');
        applyAdminUI();
      } else if(pin !== null) {
        alert('Falsche PIN.');
      }
    });

    // ===== Admin verlassen / Rolle wechseln =====
    if (exitAdminBtn) {
      exitAdminBtn.addEventListener('click', async ()=>{
     // Admin deaktivieren
       isAdmin = false;
        sessionStorage.setItem('is_admin','false');
        applyAdminUI();

        // Optional: Schüler-Stand sofort laden
        // await fetchCentralHotspots(true);

        // Rollen-Dialog erneut öffnen (falls gewünscht)
        if (typeof openRoleModal === 'function') {
          openRoleModal();
       }
      });
} 

    function applyAdminUI(){
      document.body.classList.toggle('is-admin', isAdmin);
      adminBtn.textContent = isAdmin ? '🔓 Admin' : '🔒 Admin';
      adminBtn.setAttribute('aria-pressed', String(isAdmin));
      adminBadge.style.display = isAdmin ? 'inline-block' : 'none';
      if(!isAdmin){ hotspotSelect.value=''; setSelectedIndex(-1); }
      refreshHotspotSelect();
      updateButtons();
      applyPointerEvents();
    }

    // ===== Render =====
    function renderHotspots(){
      overlay.innerHTML = '';
      for(let i=0;i<hotspots.length;i++){
        const h = hotspots[i];
        const g = document.createElementNS('http://www.w3.org/2000/svg','g');
        g.setAttribute('class','hotspot');
        g.setAttribute('tabindex','0'); g.setAttribute('role','button'); g.setAttribute('aria-label', h.id);

        if(h.shape==='polygon'){
          const poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
          poly.setAttribute('points', h.points.map(p=>`${p.x},${p.y}`).join(' '));
          poly.setAttribute('class','poly-fill');
          poly.style.pointerEvents = 'all';
          poly.addEventListener('click', (e)=>{ if(!measureMode && !editing){ e.stopPropagation(); openSlide(h);} });
          poly.addEventListener('dblclick', (e)=>{ if(isAdmin){ e.preventDefault(); setSelectedIndex(i); enterEditMode(); }});
          g.appendChild(poly);

          if(isAdmin && labelsOn){
            const cx = h.points.reduce((a,p)=>a+p.x,0)/h.points.length;
            const cy = h.points.reduce((a,p)=>a+p.y,0)/h.points.length - 1.2;
            const label = document.createElementNS('http://www.w3.org/2000/svg','text');
            label.setAttribute('class','label'); label.setAttribute('x', cx); label.setAttribute('y', cy);
            label.textContent = h.id; g.appendChild(label);
          }
        }
        overlay.appendChild(g);
      }

      if(measureMode){
        tempLayer = document.createElementNS('http://www.w3.org/2000/svg','g');
        tempLayer.setAttribute('id','measureLayer');
        const catcher = document.createElementNS('http://www.w3.org/2000/svg','rect');
        catcher.setAttribute('x','0'); catcher.setAttribute('y','0'); catcher.setAttribute('width','100'); catcher.setAttribute('height','100');
        catcher.setAttribute('fill','transparent'); catcher.style.pointerEvents = 'all';
        catcher.addEventListener('click', onMeasureClick);
        tempLayer.appendChild(catcher);
        overlay.appendChild(tempLayer);
      }

      if(editing){ drawEditOverlay(); }
                        // --- Sichtbarer Button für 'Keller' (Treppen-Emoji) ---
                  // Vorher alte Buttons entfernen (falls re-render):
                  document.querySelectorAll('.wrap .hotspot-btn').forEach(el => el.remove());

                  const wrapEl = document.querySelector('.wrap');
                  const kellerIndex = hotspots.findIndex(h => slugify(h.id) === 'keller' && h.shape === 'polygon');

                  if (wrapEl && kellerIndex >= 0) {
                    const h = hotspots[kellerIndex];
                    if (Array.isArray(h.points) && h.points.length) {
                      // Schwerpunkt berechnen (einfacher Mittelwert)
                     const { x: cx, y: cy } = insidePointFor(h.points);


                      // Button erstellen und positionieren (in % relativ zur .wrap)
                      const btn = document.createElement('button');
                      btn.className = 'hotspot-btn';
                      btn.type = 'button';
                      btn.setAttribute('aria-label', 'Keller öffnen');
                      btn.title = 'Keller';
                      btn.innerHTML = `
                         <svg
   version="1.1"
   id="svg2"
   width="299.97754"
   height="265.98761"
   viewBox="0 0 299.97754 265.98761"
   sodipodi:docname="Screenshot 2025-09-20 135033.png"
   inkscape:export-filename="Screenshot 2025-09-20 135033.svg"
   inkscape:export-xdpi="96"
   inkscape:export-ydpi="96"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg">
  <defs
     id="defs6">
    <inkscape:path-effect
       effect="fill_between_many"
       method="originald"
       linkedpaths="#path170,0,1"
       id="path-effect343"
       is_visible="true"
       lpeversion="0"
       join="true"
       close="true"
       autoreverse="true" />
  </defs>
  <sodipodi:namedview
     id="namedview4"
     pagecolor="#ffffff"
     bordercolor="#000000"
     borderopacity="0.25"
     inkscape:showpageshadow="2"
     inkscape:pageopacity="0.0"
     inkscape:pagecheckerboard="0"
     inkscape:deskcolor="#d1d1d1"
     showgrid="false" />
  <g
     inkscape:groupmode="layer"
     inkscape:label="Image"
     id="g8"
     transform="translate(-10.365887,-31)">
    <path
       style="fill:#C5CBD2; stroke:#111; stroke-width:2;"
       inkscape:original-d="M 0,0"
       inkscape:path-effect="#path-effect343"
       d="M 135.44305,292.73751 C 120.60862,284.93543 106.95134,276.58308 91.60894,265.93001 83.236428,260.11651 72.193945,252.7668 67.070089,249.59731 61.946233,246.42782 53.64684,240.81726 48.626994,237.1294 43.607147,233.44154 34.775,227.40139 29,223.70684 23.225,220.0123 17.035985,215.75435 15.246633,214.24474 L 11.993267,211.5 10.952014,186.58033 c -0.84194,-20.14962 -0.793441,-25.15394 0.253366,-26.14357 2.166022,-2.04773 17.50218,-8.43085 32.29462,-13.44147 l 14,-4.7422 -0.5,-7.37655 c -0.275,-4.0571 -0.5,-12.7338 -0.5,-19.28155 V 103.68997 L 69,98.355203 c 6.875,-2.934123 17.9,-7.251866 24.5,-9.594986 l 12,-4.260217 1,-18.442363 1,-18.442364 5.5,-2.247442 C 121.84655,41.7529 168.77318,31 175.7025,31 c 1.86256,0 6.17895,0.655149 9.59198,1.455886 8.35224,1.959531 20.38995,4.342404 30.70552,6.078179 4.675,0.786651 10.525,1.883056 13,2.436457 2.475,0.553401 9.675,1.941756 16,3.085234 20.15517,3.643794 37.26166,6.998678 45.5,8.923351 4.4,1.027946 10.1007,2.150225 12.66823,2.493953 2.56753,0.343729 5.10444,1.165407 5.63759,1.825951 0.78127,0.967959 2.01359,136.279349 1.34641,147.838329 -0.12867,2.2292 -1.58373,3.44789 -9.40223,7.87483 -5.0875,2.88061 -15.325,8.93867 -22.75,13.46236 -15.46499,9.42206 -37.52977,21.30144 -85.5,46.03205 -9.35,4.82031 -21.5,11.3417 -27,14.49199 -10.27919,5.8877 -18.89691,10.01097 -20.87712,9.98894 -0.61758,-0.007 -4.74851,-1.91937 -9.17983,-4.25 z"
       id="path345"
       class="UnoptimicedTransforms" />
    <path
       style="fill:#000000; stroke:#111; stroke-width:2;"
       d="M 135.44305,292.73751 C 120.60862,284.93543 106.95134,276.58308 91.60894,265.93001 83.236428,260.11651 72.193945,252.7668 67.070089,249.59731 61.946233,246.42782 53.64684,240.81726 48.626994,237.1294 43.607147,233.44154 34.775,227.40139 29,223.70684 23.225,220.0123 17.035985,215.75435 15.246633,214.24474 L 11.993267,211.5 10.952014,186.58033 c -0.84194,-20.14962 -0.793441,-25.15394 0.253366,-26.14357 2.166022,-2.04773 17.50218,-8.43085 32.29462,-13.44147 l 14,-4.7422 -0.5,-7.37655 c -0.275,-4.0571 -0.5,-12.7338 -0.5,-19.28155 V 103.68997 L 69,98.355203 c 6.875,-2.934123 17.9,-7.251866 24.5,-9.594986 l 12,-4.260217 1,-18.442363 1,-18.442364 5.5,-2.247442 C 121.84655,41.7529 168.77318,31 175.7025,31 c 1.86256,0 6.17895,0.655149 9.59198,1.455886 8.35224,1.959531 20.38995,4.342404 30.70552,6.078179 4.675,0.786651 10.525,1.883056 13,2.436457 2.475,0.553401 9.675,1.941756 16,3.085234 20.15517,3.643794 37.26166,6.998678 45.5,8.923351 4.4,1.027946 10.1007,2.150225 12.66823,2.493953 2.56753,0.343729 5.10444,1.165407 5.63759,1.825951 0.78127,0.967959 2.01359,136.279349 1.34641,147.838329 -0.12867,2.2292 -1.58373,3.44789 -9.40223,7.87483 -5.0875,2.88061 -15.325,8.93867 -22.75,13.46236 -15.46499,9.42206 -37.52977,21.30144 -85.5,46.03205 -9.35,4.82031 -21.5,11.3417 -27,14.49199 -10.27919,5.8877 -18.89691,10.01097 -20.87712,9.98894 -0.61758,-0.007 -4.74851,-1.91937 -9.17983,-4.25 z M 142.9054,272.25 c -0.052,-10.3125 -0.61454,-25.49794 -1.25,-33.74542 l -1.1554,-14.99541 -5.00647,-2.50459 c -2.75356,-1.37752 -9.95356,-4.71114 -16,-7.40805 -6.04644,-2.69691 -12.64915,-5.94493 -14.67269,-7.21782 -6.080106,-3.82466 -60.789047,-31.00855 -68.32084,-33.9474 -3.85,-1.50224 -10.132476,-4.21886 -13.961058,-6.03694 -3.828582,-1.81807 -7.136855,-3.12979 -7.351717,-2.91493 -0.214863,0.21486 0.105113,9.41972 0.711058,20.45525 C 16.504227,194.97021 17,205.27711 17,206.83891 c 0,2.55977 1.437982,3.76713 14.590426,12.25036 8.024734,5.1759 21.412234,14.15051 29.75,19.94358 C 69.678192,244.82592 78.3,250.64795 80.5,251.9707 c 2.2,1.32275 9.625,6.08307 16.5,10.57849 6.875,4.49542 16.775,10.68387 22,13.7521 5.225,3.06823 12.425,7.59637 16,10.06252 3.575,2.46615 6.8375,4.51817 7.25,4.56005 0.4125,0.0419 0.70743,-8.36136 0.6554,-18.67386 z M 180,272.17437 c 16.225,-9.06987 33.87171,-18.86544 39.21492,-21.76793 5.3432,-2.90248 12.7682,-7.05305 16.5,-9.22347 3.73179,-2.17043 11.96008,-6.52982 18.28508,-9.68753 6.325,-3.15772 12.625,-6.5286 14,-7.49086 2.23961,-1.56733 26.91359,-15.1459 34.5,-18.98603 l 3,-1.51855 V 173 c 0,-16.775 -0.40887,-48.8375 -0.9086,-71.25 C 303.76486,64.680343 303.53167,61 302.00946,61 300.65575,61 277.39103,66.760486 249,74.125467 c -7.6902,1.994931 -7.30595,0.385876 -6.88092,28.814303 l 0.38092,25.47758 -2.5,1.28536 c -2.39856,1.2332 -9.02528,3.68215 -37.5,13.8584 -7.15,2.55526 -13.55655,5.0995 -14.23678,5.65388 -0.93033,0.7582 -1.20224,7.30217 -1.09739,26.41054 0.0767,13.97142 -0.0418,25.57094 -0.26322,25.77669 -0.22144,0.20576 -9.92849,5.13316 -21.57124,10.94977 -11.64274,5.81662 -21.38985,10.93362 -21.66025,11.37112 -0.27039,0.43751 0.13286,8.44129 0.8961,17.78618 0.76325,9.34489 1.39786,24.31904 1.41025,33.27589 l 0.0225,16.28519 2.25,-1.20265 c 1.2375,-0.66146 15.525,-8.62347 31.75,-17.69335 z M 157.81568,213.0963 c 8.32035,-4.34703 16.4906,-8.50688 18.15612,-9.24411 1.66551,-0.73723 3.0282,-1.63301 3.0282,-1.99062 0,-0.35762 -4.6125,-2.46408 -10.25,-4.68104 -5.6375,-2.21695 -16.55,-7.16535 -24.25,-10.99644 -7.7,-3.83108 -19.625,-9.44489 -26.5,-12.47512 -6.875,-3.03023 -18.575,-8.54264 -26,-12.24979 -7.425,-3.70715 -17.767496,-8.72466 -22.983325,-11.15002 l -9.483326,-4.40975 -9.516674,3.69238 c -9.656718,3.74671 -17.553982,6.71118 -26.420504,9.91769 -4.803876,1.73728 -4.854833,1.79903 -2.5,3.02922 1.322106,0.69069 6.615219,2.89992 11.762474,4.90941 9.802867,3.82705 26.445867,11.48867 36.641355,16.86789 9.155369,4.83044 71.91813,36.45308 72.59388,36.57598 0.32663,0.0594 7.40144,-3.44864 15.7218,-7.79568 z M 183,179.13957 c 0,-10.92323 0.2712,-21.83906 0.60267,-24.2574 l 0.60267,-4.39697 -13.35267,-4.37096 C 155.19535,140.98885 138.67006,135.31633 124,130.03143 c -5.775,-2.08044 -15.9,-5.70005 -22.5,-8.04358 -6.6,-2.34352 -17.742732,-6.4495 -24.761626,-9.1244 C 69.71948,110.18855 63.024466,108 61.860566,108 c -1.880375,0 -2.052453,0.41787 -1.544261,3.75 0.314556,2.0625 0.887464,10.20652 1.273128,18.09783 l 0.701206,14.34783 4.452414,1.90852 c 2.448827,1.04969 10.820933,5.00955 18.60468,8.79969 15.465337,7.53054 26.758297,12.77673 30.652267,14.23964 4.04664,1.52026 15.38611,6.84236 31.46458,14.76765 13.3099,6.56062 32.7124,14.95735 34.78542,15.05391 0.4125,0.0192 0.75,-8.90226 0.75,-19.8255 z M 211.17574,138 c 0.97401,0 23.99393,-9.00592 24.7953,-9.70048 0.92595,-0.80255 -2.38139,-2.12458 -10.8609,-4.34138 -4.73558,-1.23802 -15.58514,-4.58662 -24.11014,-7.44135 -17.6686,-5.9166 -3.22634,-1.94169 -85.74837,-25.59804 l -6.24837,-1.791202 -10.251629,3.363631 c -11.466429,3.762214 -29.669283,11.026471 -31.023393,12.380581 -0.899674,0.89968 2.995758,2.46548 33.271762,13.37389 30.6934,11.0588 41.44297,14.86204 62.48678,22.10811 l 20.98678,7.22643 12.89184,-4.7901 C 204.45591,140.15554 210.67057,138 211.17574,138 Z m 28.77337,-16.75 c -0.10877,-10.15177 -1.75184,-45.386063 -2.13431,-45.768537 -0.22214,-0.22214 -6.45885,-1.581601 -13.85935,-3.021025 C 216.55495,71.021015 207.35,68.986973 203.5,67.940345 c -5.9421,-1.615367 -29.81431,-5.964087 -69,-12.569498 -4.95,-0.834406 -12.2625,-2.08695 -16.25,-2.783431 L 111,51.321087 V 69.050993 86.7809 l 8.25,2.161891 c 4.5375,1.18904 9.375,2.59326 10.75,3.120488 1.375,0.527228 11.5,3.393523 22.5,6.369543 11,2.976018 25.85,7.290498 33,9.587728 7.15,2.29722 15.7,4.99049 19,5.98502 3.3,0.99454 12.3,4.05107 20,6.7923 7.7,2.74122 14.3375,5.03311 14.75,5.09308 0.4125,0.06 0.7271,-2.02845 0.69911,-4.64095 z M 274,62.968883 c 7.425,-1.804157 13.82922,-3.561938 14.23159,-3.906179 0.40238,-0.344241 -5.89762,-1.841149 -14,-3.326462 C 266.12922,54.250929 252.75,51.695159 244.5,50.056752 236.25,48.418345 222.525,45.707554 214,44.032771 205.475,42.357989 192.03674,39.660972 184.13719,38.0394 l -14.36281,-2.948312 -8.63719,1.978796 C 145.50791,40.650581 135.56732,43.103681 131,44.507023 c -2.475,0.760462 -6.4125,1.874824 -8.75,2.476361 C 117.50573,48.204284 116.5628,50 120.66598,50 c 1.46628,0 12.82878,1.801185 25.25,4.002633 12.42121,2.201448 27.98402,4.925056 34.58402,6.052463 6.6,1.127406 19.2,3.79605 28,5.930319 8.8,2.134269 19.375,4.475526 23.5,5.202794 7.34929,1.295735 7.71099,1.259396 18,-1.808367 5.775,-1.721871 16.575,-4.606802 24,-6.410959 z"
       id="path170"
       sodipodi:nodetypes="sssssscssscsscsscccsssssssssssssscssscsssssssssssssssssssssscssssscssssssssscssssssssssscssssssssscssssssscssssssssssscsssscsssssssscccsssssssssssssscssssssssss"
       class="UnoptimicedTransforms" />
  </g>
</svg>

`;

                      btn.style.left = cx + '%';
                      btn.style.top  = (cy + 30 ) + '%'; // optisch leicht nach oben versetzt

                      // Klick öffnet die ganz normale Slide des Bereichs
                      btn.addEventListener('click', (e)=>{
                        e.stopPropagation();
                        openSlide(h);
                      });

                      wrapEl.appendChild(btn);
                    }
                  }

      
      applyPointerEvents();
      document.getElementById('toggleLabels')?.setAttribute('aria-pressed', String(labelsOn));
    }
// === INFO: App-Page öffnen ===
function openLinksAppPage(){
  // Herkunft bestimmen: Slide noch zu? -> Startseite, sonst aktueller Bereich
  const openedFromHome = !slide.classList.contains('open');
  appOrigin = openedFromHome ? APP_FROM_HOME : (lastAreaSlug || APP_FROM_HOME);

  // Slide öffnen & App-Modus aktivieren
  slide.classList.add('open');
  slide.classList.add('app-mode');

  // Bild ausblenden & alten Inhalt merken (für sauberes Zurück)
  if (slideImg) slideImg.style.display = 'none';
  if (!slideDesc.dataset.prev) slideDesc.dataset.prev = slideDesc.innerHTML;

  slideTitle.textContent = '';
  slideMeta.textContent = '';

  // Inhalt: Raster aus Kacheln/Buttons
    slideDesc.innerHTML = `
  <div class="app-page">
    <div class="app-grid">
      <div class="app-list">

          <div class="app-row">
            <button class="tool-btn app-tile" id="appOpenBrowser" type="button" title="Externe Seite öffnen">
              <span class="tool-icon">🏛️</span>
              <span class="label" style="display:none">Browser</span>
            </button>
            <div class="app-desc">
              <span class="title">Haus Rühlstraße - Erfurt </span>
              <span></span>
            </div>
          </div>

            <div class="app-row">
                <button class="tool-btn app-tile" id="appOpenNotes" type="button" title="Notizen öffnen">
                  <span class="tool-icon">🗒️</span>
                  <span class="label" style="display:none">Notizen</span>
                </button>
                <div class="app-desc">
                  <span class="title">Themen</span>
                  <span>Stationen der Unterrichtsreihe.</span>
                </div>
              </div>


                      <div class="app-row">
              <button class="tool-btn app-tile" id="appOpenOlat" type="button" title="OpenOlat öffnen">
                <span class="tool-icon">♾️</span>
                <span class="label" style="display:none">OpenOlat</span>
              </button>
              <div class="app-desc">
                <span class="title">OpenOlat</span>
                <span> Materialien </span>
              </div>
            </div>
   
                        <div class="app-row">
              <button class="tool-btn app-tile" id="appOpenLinks" type="button" title="Hilfreiche Websites öffnen">
                <span class="tool-icon">🌐</span>
                <span class="label" style="display:none">Links</span>
              </button>
              <div class="app-desc">
                <span class="title">Hilfreiche Websites</span>
                <span></span>
              </div>
            </div>

            <div class="app-row">
                <button class="tool-btn app-tile" id="appOpenContact" type="button" title="Kontaktformular öffnen">
                  <span class="tool-icon">✉️</span>
                  <span class="label" style="display:none">Kontakt</span>
                </button>
                <div class="app-desc">
                  <span class="title">Kontakt</span>
                  <span>Schreibe eine Nachricht an den Kunden.</span>
                </div>
              </div>

              </div>
            </div>
          </div>
`;
      // Browser-Kachel: Warnen & externen Link öffnen
      const btnBrowser = document.getElementById('appOpenBrowser');
      if (btnBrowser) {
        btnBrowser.addEventListener('click', () => {
          const url = 'https://www.detail.de/de_de/bekroenendes-fusswalmdach-haus-ruehlstrasse-von-alex-lehnerer?srsltid=AfmBOopyNHUNIz6VSFoaIWwCU42yu5f0VcStJDTrlKlZed10'; // <- deine Ziel-URL
          const ok = confirm('Achtung: Sie verlassen die App und öffnen eine externe Website. Fortfahren?');
          if (ok) window.open(url, '_blank');
        });
      }
            // === OpenOlat-Button Event ===
      const btnOlat = document.getElementById('appOpenOlat');
      if (btnOlat) {
        btnOlat.addEventListener('click', () => {
          const url = 'https://olat.bbslu.de/auth/RepositoryEntry/171835477/CourseNode/112064557938997/path%3D~~Projekt%20Stadtvilla%20M%C3%BCller/0'; // <- hier deine echte OLAT-URL einsetzen
          const ok = confirm('Achtung: Sie verlassen die App und öffnen OpenOlat. Fortfahren?');
          if (ok) window.open(url, '_blank');
        });
      }

// === Notizen-Button Event (ersetzt die alte Version) ===
const btnNotes = document.getElementById('appOpenNotes');
if (btnNotes) {
  btnNotes.addEventListener('click', () => {
    // Wir bleiben im app-mode, nur den Inhalt der Slide austauschen,
    // damit die Seite genauso aussieht wie die App-Page (gleiches Grid).
    slide.classList.add('app-mode');         // sicherstellen
    slideTitle.textContent = '';             // kein Titel
    slideMeta.textContent = '';              // keine Meta-Zeile

    slideDesc.innerHTML = `
      <div class="app-page">
        <div class="app-grid">
          <div class="app-list">

            <!-- Platzhalter 1 -->
            <div class="app-row">
              <button class="tool-btn app-tile app-tile--disabled" type="button" title="Platzhalter">
                <span class="tool-icon">⬜</span>
                <span class="label" style="display:none">Maßgebung im Hochbau</span>
              </button>
              <div class="app-desc">
                <span class="title">Platzhalter</span>
                <span>Maßordnung im Hochbau.</span>
              </div>
            </div>

            <!-- Platzhalter 2 -->
            <div class="app-row">
              <button class="tool-btn app-tile app-tile--disabled" type="button" title="Platzhalter">
                <span class="tool-icon">⬜</span>
                <span class="label" style="display:none">Platzhalter</span>
              </button>
              <div class="app-desc">
                <span class="title">Platzhalter</span>
                <span>Weitere Kachel als Platzhalter für kommende Inhalte.</span>
              </div>
            </div>

            <!-- Platzhalter 3 -->
            <div class="app-row">
              <button class="tool-btn app-tile app-tile--disabled" type="button" title="Platzhalter">
                <span class="tool-icon">⬜</span>
                <span class="label" style="display:none">Platzhalter</span>
              </button>
              <div class="app-desc">
                <span class="title">Platzhalter</span>
                <span>Noch eine Kachel für zukünftige Funktionen.</span>
              </div>
            </div>

          </div>
        </div>
      </div>
    `;

    // KEINE Event-Handler binden -> bewusst funktionslos
    // Home/Back (🏠) läuft weiterhin über deinen bestehenden backBtn-Handler.
  });
}
// === Kontakt-Button Event ===
const btnContact = document.getElementById('appOpenContact');
if (btnContact) {
  btnContact.addEventListener('click', () => {
    slide.classList.add('app-mode');
    slideTitle.textContent = '';
    slideMeta.textContent = '';

    slideDesc.innerHTML = `
      <div class="app-page">
        <div class="contact-form">
          <h2>Kontaktformular</h2>
          <label for="contactName">Ihr Name:</label>
          <input type="text" id="contactName" placeholder="Name eingeben">

          <label for="contactMsg">Ihre Nachricht:</label>
          <textarea id="contactMsg" placeholder="Nachricht eingeben"></textarea>

                  <div class="app-row">
          <button class="tool-btn app-tile" id="sendMailBtn" type="button" title="Nachricht senden">
            <span class="tool-icon">📨</span>
            <span class="label" style="display:none">Senden</span>
          </button>
          <div class="app-desc">
            <span class="title">Senden</span>
            <span>Schickt die Nachricht an Herr Müller.</span>
          </div>
        </div>

        </div>
      </div>
    `;

    // Klick-Event für "Senden"
    const sendBtn = document.getElementById('sendMailBtn');
    if (sendBtn) {
      sendBtn.addEventListener('click', () => {
        const name = document.getElementById('contactName').value.trim();
        const msg  = document.getElementById('contactMsg').value.trim();

        const subject = encodeURIComponent("Anfrage vom Kunden");
        const body    = encodeURIComponent("Name: " + name + "\n\nNachricht:\n" + msg);

        // Deine Zieladresse hier eintragen:
        window.location.href = "mailto:horst.mueller-architekt@mein.gmx?subject=" + subject + "&body=" + body;
      });
    }
  });
}

// === Links-Button Event ===
const btnLinks = document.getElementById('appOpenLinks');
if (btnLinks) {
  btnLinks.addEventListener('click', () => {
    slide.classList.add('app-mode');
    slideTitle.textContent = '';
    slideMeta.textContent = '';

    // Inhalt für die Links-Seite
    slideDesc.innerHTML = `
      <div class="app-page">
        <div class="app-grid">
          <div class="app-list">

            <!-- Beispiel-Link 1 -->
            <div class="app-row">
              <button class="tool-btn app-tile" type="button" title="Architektur Vorlagen"
                onclick="window.open('https://example.com/architektur', '_blank')">
                <span class="tool-icon">📐</span>
                <span class="label" style="display:none">Architektur</span>
              </button>
              <div class="app-desc">
                <span class="title">Architektur-Vorlagen</span>
                <span>Externe Seite mit Entwürfen und Zeichnungen.</span>
              </div>
            </div>

            <!-- Beispiel-Link 2 -->
            <div class="app-row">
              <button class="tool-btn app-tile" type="button" title="Baustoffe"
                onclick="window.open('https://example.com/baustoffe', '_blank')">
                <span class="tool-icon">🏗️</span>
                <span class="label" style="display:none">Baustoffe</span>
              </button>
              <div class="app-desc">
                <span class="title">Baustoffe</span>
                <span>Hilfreiche Website zu Materialien.</span>
              </div>
            </div>

          </div>
        </div>
      </div>
    `;
  });
}

  

  // Aktionen verdrahten (nutzt vorhandene Funktionen)
  document.getElementById('appOpenGallery')?.addEventListener('click', ()=> openLightbox(1));
  document.getElementById('appPlayVideo')?.addEventListener('click', openContextVideo);
  document.getElementById('appServerLoad')?.addEventListener('click', ()=> fetchCentralHotspots(true));
  document.getElementById('appExport')?.addEventListener('click', exportHotspots);
  document.getElementById('appShare')?.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(location.href); alert('Link kopiert!'); }
    catch{ prompt('Kopiere den Link:', location.href); }
  });
}



        // Links-Buttons (Start + Slide) an App-Page binden
        // (Start-Toolbar hat .slide-tools--mini, Slide unten normale .slide-tools)
        document.querySelectorAll('.linksBtn').forEach(btn=>{
        btn.addEventListener('click', openLinksAppPage);
        });

    // ===== Hintergrund ermitteln (ohne fetch, server- & file-Modus tauglich) =====
    function tryLoadImageSequential(urls, onOk, onFail){
      let i = 0; const img = new Image();
      const next = ()=>{
        if(i >= urls.length){ onFail && onFail(); return; }
        img.onload = ()=> onOk(urls[i]);
        img.onerror = ()=>{ i++; next(); };
        img.src = urls[i];
      };
      next();
    }

    function backgroundCandidates(slug){
      return [ `${assetsBase}/${slug}/bg.webp`, `${assetsBase}/${slug}/bg.png`, `${assetsBase}/${slug}/bg.jpg` ];
    }

    // ===== Galerie-Logik für mehrere Hintergrundbilder =====
    const gallery = { slug:null, index:1, cache:new Map(), hasAny:false };
    function bgUrlFor(slug, i, ext){ const n = i<=1 ? '' : String(i); return `${assetsBase}/${slug}/bg${n}.${ext}`; }
    function findBg(slug, i){
      return new Promise(resolve=>{
        const urls = ['webp','png','jpg'].map(ext=>bgUrlFor(slug,i,ext));
        tryLoadImageSequential(urls, url=>resolve(url), ()=>resolve(null));
      });
    }
    async function showIndex(i){
      if(!gallery.slug) return false;
      let url = gallery.cache.get(i);
      if(!url){ url = await findBg(gallery.slug, i); if(url) gallery.cache.set(i, url); }
      if(url){
        slideImg.src = url;
        slideImg.style.transform = 'none';
        slideMeta.textContent = `Bild ${i}`;
        gallery.index = i;
        return true;
      }
      return false;
    }
    function setNavVisible(v){ nextBgBtn.style.display = v ? 'inline-block' : 'none'; }

    // ===== Neue Folie (Slide) =====
    // ===== Neue Folie (Slide) =====
function openSlide(h){
  // UI zurücksetzen
  slide.classList.remove('app-mode');
  if (slideImg) slideImg.style.display = '';
  const id = slugify(h.id||'');
  lastAreaSlug = id; // Bereich merken

  // Inhalte aus Code
  const c = contents[id];
  slideTitle.textContent = c?.title || h.id || id;
  slideDesc.innerHTML = c?.html || `<p>Für den Bereich <strong>${h.id}</strong> ist noch kein Inhalt hinterlegt.</p>`;

  // Reset Galerie-Status
  gallery.slug = null; gallery.index = 1; gallery.cache = new Map(); gallery.hasAny = false; setNavVisible(false);

  // Hintergrund: erst bereichsspezifisch, sonst gezoomtes Hausbild
  tryLoadImageSequential(backgroundCandidates(id), async (url)=>{
    // eigenes Bild nur im Bildbereich
    slideImg.src = url; 
    slideImg.style.transform = 'none';
    slideMeta.textContent = 'Bild 1';
    slide.classList.add('slide--contain');
    slide.classList.add('open'); // Slide sichtbar
    // Button nach dem Öffnen der Slide bauen (Erfolgsfall)
    requestAnimationFrame(() => {  try { buildTutorialButtonForSlide(); } catch (e) { console.warn(e); }});  //tut Button fix

    // Galerie aktivieren
    gallery.slug = id; gallery.index = 1; gallery.cache.set(1, url); gallery.hasAny = true; setNavVisible(true);
    // Tutorial-Button bauen
    requestAnimationFrame(()=>{ 
    try { 
        buildTutorialButtonForSlide(); 
    } catch(e) {console.warn(e); 
    } 
});


  }, ()=>{
    // Fallback auf Hausbild + Zoom
    const baseSrc = document.getElementById('baseImage').src;
    slideImg.src = baseSrc;
    const cx = h.points.reduce((a,p)=>a+p.x,0)/h.points.length;
    const cy = h.points.reduce((a,p)=>a+p.y,0)/h.points.length;
    const s = Math.max(1, zoom);
    const maxShift = 100 - (100/s);
    const tx = clamp(cx - 50/s, 0, Math.max(0, maxShift));
    const ty = clamp(cy - 50/s, 0, Math.max(0, maxShift));
    slideImg.style.transformOrigin = 'top left';
    slideImg.style.transform = `translate(-${tx}%, -${ty}%) scale(${s})`;
    slideMeta.textContent = `Zoom ${s.toFixed(1)}×`;
    slide.classList.add('open');
    slide.classList.remove('slide--contain');

    setNavVisible(false);

    // NEU: auch im Fallback den Button nach dem Öffnen bauen
    requestAnimationFrame(()=>{ try{ buildTutorialButtonForSlide(); }catch(e){ console.warn(e); } });
  });

  // Klasse für bereichsspezifische Styles
  slide.classList.forEach(c=>{ if(c.startsWith('area--')) slide.classList.remove(c); });
  slide.classList.add(`area--${id}`);

  // Optional: Bereichs-Tutorial automatisch (einmal pro Bereich)
  if (typeof startAreaTutorialOnce === 'function') {
    setTimeout(()=> startAreaTutorialOnce(id), 300);
  }
}


   function closeSlide(){
      slide.classList.remove('open');
      slide.classList.remove('app-mode'); // << NEU
      slideImg.style.transform = 'none';
      }

      // Vorherige Listener sicher entfernen & Lightbox öffnen
            nextBgBtn.replaceWith(nextBgBtn.cloneNode(true));
             const nextBgBtnNew = document.getElementById('nextBgBtn');
             nextBgBtn = nextBgBtnNew;   // <<< NEU: Referenz aktualisieren!
             nextBgBtn.addEventListener('click', ()=> {
          openLightbox(1);
        });

// ===== Lightbox / Slideshow =====
const lb = document.getElementById('lightbox');
const lbImg = document.getElementById('lbImg');
const lbPrev = document.getElementById('lbPrev');
const lbNext = document.getElementById('lbNext');
const lbClose = document.getElementById('lbClose');
const lbMeta = document.getElementById('lbMeta');

let lbIndex = 1;
let lbCount = 0;
let lbUrls = [];

async function buildGalleryList(slug){
  const urls = [];
  let i = 1;
  while(true){
    const url = await findBg(slug, i);
    if(!url) break;
    urls.push(url);
    i++;
    if(i > 50) break;
  }
  return urls;
}

async function openLightbox(startIndex=1){
  if(!gallery.slug){
    const baseSrc = document.getElementById('baseImage').src;
    lbUrls = [baseSrc];
  } else {
    lbUrls = await buildGalleryList(gallery.slug);
    if(lbUrls.length === 0){
      const baseSrc = document.getElementById('baseImage').src;
      lbUrls = [baseSrc];
    }
  }
  lbCount = lbUrls.length;
  lbIndex = Math.min(Math.max(1, startIndex), lbCount);
  showLightboxIndex(lbIndex);
  lb.style.display = 'grid';
  document.body.style.overflow = 'hidden';
}

function closeLightbox(){
  lb.style.display = 'none';
  document.body.style.overflow = '';

  // NEU: Endbild NUR in der Slide setzen
  if (lastAreaSlug) {
    slideImg.src = `${assetsBase}/${lastAreaSlug}/end.${END_EXT}`; // z.B. .webp
    slideImg.style.transform = 'none';           // sicherheitshalber Zoom/Fallback aus
    slideMeta.textContent = 'Abschlussbild';     // optionaler Hinweis in der Meta-Zeile
  }
}

function showLightboxIndex(i){
  lbImg.src = lbUrls[i-1];
  lbMeta.textContent = `Bild ${i} / ${lbCount}`;
  lbIndex = i;
}

function nextLightbox(){
  const n = lbIndex + 1;
  showLightboxIndex(n > lbCount ? 1 : n);
}

function prevLightbox(){
  const p = lbIndex - 1;
  showLightboxIndex(p < 1 ? lbCount : p);
}

// Buttons
lbNext.addEventListener('click', nextLightbox);
lbPrev.addEventListener('click', prevLightbox);
lbClose.addEventListener('click', closeLightbox);

// ESC & Pfeiltasten
window.addEventListener('keydown', (e)=>{
  if(lb.style.display === 'none') return;
  if(e.key === 'Escape') closeLightbox();
  else if(e.key === 'ArrowRight') nextLightbox();
  else if(e.key === 'ArrowLeft') prevLightbox();
});

// Touch-Wischgesten
let touchStartX = null;
lb.addEventListener('touchstart', (e)=>{ touchStartX = e.touches[0].clientX; }, {passive:true});
lb.addEventListener('touchend', (e)=>{
  if(touchStartX == null) return;
  const dx = e.changedTouches[0].clientX - touchStartX;
  touchStartX = null;
  const TH = 40;
  if(dx < -TH) nextLightbox();
  else if(dx > TH) prevLightbox();
}, {passive:true});

// Klick auf Hintergrund schließt
lb.addEventListener('click', (e)=>{
  if(e.target === lb) closeLightbox();
});

    // ===== Toolbar =====
    document.getElementById('toggleLabels').addEventListener('click', ()=>{
      labelsOn = !labelsOn; renderHotspots();
      document.getElementById('toggleLabels').setAttribute('aria-pressed', String(labelsOn));
    });
    document.getElementById('shareLink').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(location.href); alert('Link kopiert!'); } catch{ prompt('Kopiere den Link:', location.href); }
    });
    document.getElementById('imgPicker')?.addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return; document.getElementById('baseImage').src = URL.createObjectURL(f);
    });

    // Assets-Pfad speichern
    assetsBaseBtn.addEventListener('click', ()=>{
      assetsBase = assetsBaseInput.value.trim() || 'assets/areas';
      saveAssetsBase(assetsBase);
      alert('Assets-Pfad gespeichert: '+assetsBase);
    });

    // ===== Mess-Tool Logik (nur Admin sichtbar) =====
    startBtn.addEventListener('click', ()=>{ if(isAdmin) toggleMeasure(true); });
    cancelBtn.addEventListener('click', ()=>{ toggleMeasure(false); });
    undoBtn.addEventListener('click', ()=>{ if(draftPoints.length){ draftPoints.pop(); drawDraft(); updateButtons(); }});
    saveBtn.addEventListener('click', ()=>{
      if(draftPoints.length<3) return;
      let id = prompt('Name (z. B. "dach")','dach');
      if(!id){ alert('Kein Name vergeben. Abgebrochen.'); return; }
      id = slugify(id);
      hotspots.push({ id, shape:'polygon', points:[...draftPoints] });
      saveHotspots();
      toggleMeasure(false);
      refreshHotspotSelect();
      renderHotspots();
    });

    function toggleMeasure(on){
      if(!isAdmin && on) return;
      if(editing && on) exitEditMode(false);
      measureMode = !!on; draftPoints = []; updateButtons(); renderHotspots();
    }
    function updateButtons(){
      measureGroup.classList.toggle('show', measureMode && isAdmin);
      startBtn.style.display = (!isAdmin || measureMode) ? 'none' : 'inline-block';
      saveBtn.disabled = draftPoints.length < 3;

      const showEditGroup = isAdmin && selectedIndex >= 0 && !measureMode;
      editGroup.style.display = showEditGroup ? 'flex' : 'none';
      const hasEdit = editing;
      addPointBtn.disabled = !hasEdit;
      removePointBtn.disabled = !hasEdit || editPoints.length < 1;
      saveEditBtn.disabled = !hasEdit;
      cancelEditBtn.disabled = !hasEdit;
    }

    function onMeasureClick(ev){
      const rect = overlay.getBoundingClientRect();
      const x = +(((ev.clientX - rect.left) / rect.width) * 100).toFixed(1);
      const y = +(((ev.clientY - rect.top) / rect.height) * 100).toFixed(1);
      draftPoints.push({x,y});
      drawDraft();
      updateButtons();
    }

    function drawDraft(){
      while(tempLayer && tempLayer.childNodes.length>1){ tempLayer.removeChild(tempLayer.lastChild); }
      if(!tempLayer) return;
      for(const p of draftPoints){
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('cx', p.x); c.setAttribute('cy', p.y); c.setAttribute('r', 0.8); c.setAttribute('fill','#fff');
        tempLayer.appendChild(c);
      }
      if(draftPoints.length>=2){
        const pl = document.createElementNS('http://www.w3.org/2000/svg','polyline');
        pl.setAttribute('points', draftPoints.map(p=>`${p.x},${p.y}`).join(' '));
        pl.setAttribute('class','edit-poly');
        tempLayer.appendChild(pl);
      }
    }

    // ===== Auswahl & Edit =====
    hotspotSelect.addEventListener('change', ()=>{
      const idx = parseInt(hotspotSelect.value,10);
      setSelectedIndex(isNaN(idx) ? -1 : idx);
    });

    renameBtn.addEventListener('click', ()=>{
      if(selectedIndex<0) return;
      const cur = hotspots[selectedIndex].id;
      let id = prompt('Neuer Name für den Bereich:', cur);
      if(!id) return;
      id = slugify(id);
      hotspots[selectedIndex].id = id;
      saveHotspots();
      refreshHotspotSelect();
      renderHotspots();
      updateEditLabel();
    });

    startEditBtn.addEventListener('click', ()=>{ enterEditMode(); });
    addPointBtn.addEventListener('click', ()=>{ if(!editing) return; addingPoint = true; ensureEditCatcher(); });
    removePointBtn.addEventListener('click', ()=>{ if(!editing) return; editPoints.pop(); drawEditOverlay(); updateButtons(); });
    saveEditBtn.addEventListener('click', ()=>{ if(!editing) return; hotspots[selectedIndex].points = [...editPoints]; saveHotspots(); exitEditMode(true); renderHotspots(); });
    cancelEditBtn.addEventListener('click', ()=>{ exitEditMode(false); });

    deleteBtn.addEventListener('click', ()=>{
      if(selectedIndex<0) return;
      if(!confirm('Diesen Bereich wirklich löschen?')) return;
      hotspots.splice(selectedIndex,1);
      saveHotspots();
      setSelectedIndex(-1);
      refreshHotspotSelect();
      renderHotspots();
    });

    function setSelectedIndex(idx){
      if(editing) exitEditMode(false);
      selectedIndex = idx;
      if(idx>=0){ hotspotSelect.value = String(idx); }
      else { hotspotSelect.value = ''; }
      updateEditLabel();
      updateButtons();
    }

    function updateEditLabel(){
      editLabel.textContent = selectedIndex>=0 ? `Bearbeite: ${hotspots[selectedIndex].id}` : 'Bearbeite: –';
    }

    function refreshHotspotSelect(){
      while(hotspotSelect.options.length>1){ hotspotSelect.remove(1); }
      hotspots.forEach((h, i)=>{
        const opt = document.createElement('option');
        opt.value = String(i); opt.textContent = `${h.id} (#${i+1})`;
        hotspotSelect.appendChild(opt);
      });
    }

    function enterEditMode(){
      if(!isAdmin || selectedIndex<0) return;
      if(measureMode) toggleMeasure(false);
      editing = true; addingPoint = false; editPoints = JSON.parse(JSON.stringify(hotspots[selectedIndex].points || []));
      drawEditOverlay();
      updateButtons();
    }

    function exitEditMode(save){
      editing = false; addingPoint = false; editPoints = []; removeEditOverlay();
      updateButtons(); applyPointerEvents();
    }

    function drawEditOverlay(){
      removeEditOverlay();
      editLayer = document.createElementNS('http://www.w3.org/2000/svg','g');
      editLayer.setAttribute('id','editLayer'); editLayer.style.pointerEvents = 'all';

      if(editPoints.length>=2){
        const pl = document.createElementNS('http://www.w3.org/2000/svg','polyline');
        pl.setAttribute('points', editPoints.map(p=>`${p.x},${p.y}`).join(' '));
        pl.setAttribute('class','edit-poly');
        editLayer.appendChild(pl);
      }

      editPoints.forEach((p, idx)=>{
        const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
        c.setAttribute('class','handle');
        c.setAttribute('cx', p.x); c.setAttribute('cy', p.y); c.setAttribute('r', 1.1);
        c.addEventListener('mousedown', (e)=> startDrag(e, idx));
        c.addEventListener('touchstart', (e)=> startDrag(e, idx));
        editLayer.appendChild(c);
      });

      if(addingPoint){ ensureEditCatcher(); }

      overlay.appendChild(editLayer);
      applyPointerEvents();
    }

    function ensureEditCatcher(){
      const exists = editLayer && editLayer.querySelector('rect[data-catcher="1"]');
      if(exists) return;
      const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
      r.setAttribute('x','0'); r.setAttribute('y','0'); r.setAttribute('width','100'); r.setAttribute('height','100');
      r.setAttribute('fill','transparent'); r.style.pointerEvents = 'all'; r.setAttribute('data-catcher','1');
      r.addEventListener('click', (ev)=>{
        if(!addingPoint) return;
        const rect = overlay.getBoundingClientRect();
        const x = +(((ev.clientX - rect.left) / rect.width) * 100).toFixed(1);
        const y = +(((ev.clientY - rect.top) / rect.height) * 100).toFixed(1);
        editPoints.push({x,y}); addingPoint = false; drawEditOverlay(); updateButtons();
      });
      editLayer.insertBefore(r, editLayer.firstChild);
    }

    function removeEditOverlay(){ if(editLayer){ editLayer.remove(); editLayer = null; } }

    function startDrag(e, idx){
      e.preventDefault(); draggingIdx = idx;
      const move = (ev)=>{
        const pt = getEventXY(ev);
        if(!pt) return; editPoints[draggingIdx] = pt; drawEditOverlay();
      };
      const up = ()=>{
        draggingIdx = -1; window.removeEventListener('mousemove', move); window.removeEventListener('touchmove', move); window.removeEventListener('mouseup', up); window.removeEventListener('touchend', up);
      };
      window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, {passive:false});
      window.addEventListener('mouseup', up); window.addEventListener('touchend', up);
    }

    function getEventXY(ev){
      const rect = overlay.getBoundingClientRect();
      let clientX, clientY;
      if(ev.touches && ev.touches[0]){ clientX = ev.touches[0].clientX; clientY = ev.touches[0].clientY; ev.preventDefault(); }
      else { clientX = ev.clientX; clientY = ev.clientY; }
      const x = +(((clientX - rect.left) / rect.width) * 100).toFixed(1);
      const y = +(((clientY - rect.top) / rect.height) * 100).toFixed(1);
      return { x: clamp(x, 0, 100), y: clamp(y, 0, 100) };
    }

    function applyPointerEvents(){
      // Hotspots sollen immer anklickbar sein – auch ohne Admin.
      overlay.style.pointerEvents = 'auto';
    }

    // ===== Persistenz (local) =====
    function loadHotspots(){
      try{ const raw = localStorage.getItem(LS_KEYS.hotspots); return raw ? JSON.parse(raw) : []; }catch{ return []; }
    }
    function saveHotspots(){
      try{ localStorage.setItem(LS_KEYS.hotspots, JSON.stringify(hotspots)); }catch{}
    }
    function loadZoom(){
      const v = parseFloat(localStorage.getItem(LS_KEYS.zoom));
      return isNaN(v) ? 2.0 : v;
    }
    function saveZoom(){
      try{ localStorage.setItem(LS_KEYS.zoom, String(zoom)); }catch{}
    }
    function loadAssetsBase(){ return localStorage.getItem(LS_KEYS.assets) || 'assets/areas'; }
    function saveAssetsBase(base){ try{ localStorage.setItem(LS_KEYS.assets, base); }catch{} }

    // ===== Zentrale Daten (Server) =====
    async function fetchCentralHotspots(showAlerts=true){
      try{
        const url = `${centralPath}?v=${Date.now()}`; // Cache-Bust
        const res = await fetch(url, { cache: 'no-cache' });
        if(!res.ok){ if(showAlerts) alert('Konnte zentrale Datei nicht laden: '+centralPath); return; }
        const json = await res.json();
        if(!Array.isArray(json.hotspots)) { if(showAlerts) alert('Ungültige Datei: Feld "hotspots" fehlt.'); return; }
        hotspots = json.hotspots;
        saveHotspots();
        if (typeof json.zoom === 'number') {
          zoom = json.zoom;
          const zs = document.getElementById('zoomSlider');
          const zo = document.getElementById('zoomOut');
          if (zs) zs.value = String(zoom);
          if (zo) zo.textContent = `${zoom.toFixed(1)}×`;
          saveZoom();
        }
        refreshHotspotSelect();
        renderHotspots();
        if(showAlerts) alert('Hotspots vom Server geladen.');
      }catch(err){
        if(showAlerts) alert('Fehler beim Laden der zentralen Hotspots.');
        console.error(err);
      }
    }

    function exportHotspots(){
      const payload = { version:1, updated:new Date().toISOString(), zoom, hotspots };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const ts = new Date().toISOString().replace(/[:.]/g,'-');
      a.download = `hotspots-${activeSetName}-${ts}.json`;
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }

    function handleImportFile(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const json = JSON.parse(reader.result);
          if(!Array.isArray(json.hotspots)) { alert('Ungültige Datei: "hotspots" fehlt.'); return; }
          hotspots = json.hotspots;
          saveHotspots();
            if (typeof json.zoom === 'number') {
              zoom = json.zoom;
              const zs = document.getElementById('zoomSlider');
              const zo = document.getElementById('zoomOut');
              if (zs) zs.value = String(zoom);
              if (zo) zo.textContent = `${zoom.toFixed(1)}×`;
              saveZoom();
            }
          refreshHotspotSelect();
          renderHotspots();
          alert('Hotspots importiert.');
        }catch(e){ alert('Konnte Datei nicht lesen.'); }
      };
      reader.readAsText(file, 'utf-8');
    }

    // ===== Events für zentrale Daten =====
    serverLoadBtn.addEventListener('click', ()=> fetchCentralHotspots(true));
    exportBtn.addEventListener('click', ()=> exportHotspots());
    importFile.addEventListener('change', (e)=>{ 
  const f = e.target.files?.[0]; 
  if (f) handleImportFile(f); 
  e.target.value = ''; 
    });


    // ===== Init =====
    (function init(){
      applyAdminUI();
      refreshHotspotSelect();
      renderHotspots();
      setHomeBgDefault(); // setzt immer 'haus.png' beim Laden
      setupRoleHandlers();
      openRoleModal();


      // Sichtbare Warnung, wenn localStorage nicht verfügbar (Privatmodus etc.)
      if(!canUseLocalStorage()){
        const w = document.getElementById('storageWarn');
        w.textContent = 'Achtung: Lokaler Speicher ist deaktiviert (Privatmodus/In‑App‑Browser). Änderungen werden nicht dauerhaft gespeichert. Nutze "Hotspots exportieren"/"Vom Server laden".';
        w.style.display = 'block';
      }

      // Automatisch vom Server laden, wenn lokal noch nichts vorhanden
      if(!hotspots || hotspots.length === 0){ fetchCentralHotspots(false); }

      // Galerie-Button initial verstecken
      setNavVisible(false);
      // ===== Rollen-Dialog =====
    function openRoleModal(){
      const m = document.getElementById('roleModal');
      if(m) m.style.display = 'grid';
        document.body.classList.add('modal-open');          // NEU
        document.querySelector('.app')?.setAttribute('aria-hidden','true');  // optional a11y
}
    function closeRoleModal(){
     const m = document.getElementById('roleModal');
      if(m) m.style.display = 'none';
        document.body.classList.remove('modal-open');       // NEU
        document.querySelector('.app')?.removeAttribute('aria-hidden');      // optional a11y
}

function setupRoleHandlers(){
  const btnS = document.getElementById('roleStudent');
  const btnT = document.getElementById('roleTeacher');
  if(!btnS || !btnT) return;

  btnS.addEventListener('click', async ()=>{
    // Schüler: Admin aus, UI anwenden, vom Server laden
    isAdmin = false;
    sessionStorage.setItem('is_admin','false');
    applyAdminUI();
    await fetchCentralHotspots(false);   // immer Serverstand laden
      // NEU: Tutorial starten
    startStudentTutorial();
    closeRoleModal();
  });

  btnT.addEventListener('click', ()=>{
    const pin = prompt('Admin-PIN eingeben:');
    if(pin === ADMIN_PIN){
      isAdmin = true;
      sessionStorage.setItem('is_admin','true');
      applyAdminUI();
      
      // Optional: Als Lehrer NICHT automatisch Server laden, damit lokale Edits bleiben:
      // Wenn du trotzdem sofort den Serverstand laden willst, hier entkommentieren:
      // fetchCentralHotspots(true);
      closeRoleModal();
    } else if(pin !== null){
      alert('Falsche PIN.');
    }
  });
}

    })();
// === Browser-Button Event ===
document.addEventListener("DOMContentLoaded", function() {
  const btnBrowser = document.getElementById("appOpenBrowser");
  if (btnBrowser) {
    btnBrowser.addEventListener("click", function() {
      const url = "https://www.google.com/" // <-- Ziel-URL eintragen
      const confirmLeave = confirm("Achtung: Sie verlassen die App und öffnen eine externe Website. Fortfahren?");
      if (confirmLeave) {
        window.open(url, "_blank");
      }
    });
  }
});

// === Tutorial (immer für Schüler, 2 Schritte) ===
(function(){
  const overlay = document.getElementById('tutOverlay');
  const focus   = document.getElementById('tutFocus');
  const arrow   = document.getElementById('tutArrow');
  const tip     = document.getElementById('tutTip');
  const tipText = document.getElementById('tutText');
  const btnSkip = document.getElementById('tutSkip');
  const btnNext = document.getElementById('tutNext');

  let steps = [];
  let stepIdx = 0;
  let relayoutBound = null;

  function placeAt(targetEl){
    if (!targetEl) return;
    const r = targetEl.getBoundingClientRect();
    const sx = window.scrollX, sy = window.scrollY;
    // Fokusrahmen
    focus.style.cssText = `display:block; left:${r.left - 8 + sx}px; top:${r.top - 8 + sy}px; width:${r.width + 16}px; height:${r.height + 16}px;`;
    // Pfeil oberhalb, zentriert
    arrow.style.cssText = `display:block; left:${r.left + r.width/2 - 17 + sx}px; top:${Math.max(8, r.top - 40) + sy}px;`;
    // Tooltip rechts vom Ziel (wenn zu wenig Platz: darunter)
    const viewW = document.documentElement.clientWidth;
    const tipLeftPref = r.right + 12 + sx;
    const tipLeft = (tipLeftPref + 300 < sx + viewW) ? tipLeftPref : (r.left + sx);
    const tipTop  = (tipLeft === tipLeftPref) ? (r.top + sy - 4) : (r.bottom + 12 + sy);
    tip.style.cssText = `display:block; left:${tipLeft}px; top:${tipTop}px;`;
  }

  function showStep(i){
    stepIdx = i;
    const s = steps[stepIdx];
    if (!s || !s.el) { endTutorial(); return; }
    tipText.textContent = s.text;
    overlay.style.display = 'block';
    focus.style.display   = 'block';
    arrow.style.display   = 'block';
    tip.style.display     = 'block';
    // Reposition bei Resize/Scroll
    if (!relayoutBound){
      relayoutBound = ()=> placeAt(s.el);
      window.addEventListener('resize', relayoutBound);
      window.addEventListener('scroll', relayoutBound, { passive:true });
    }
    placeAt(s.el);
  }

  function endTutorial(){
    overlay.style.display = 'none';
    focus.style.display   = 'none';
    arrow.style.display   = 'none';
    tip.style.display     = 'none';
    if (relayoutBound){
      window.removeEventListener('resize', relayoutBound);
      window.removeEventListener('scroll', relayoutBound);
      relayoutBound = null;
    }
  }

  btnSkip.addEventListener('click', endTutorial);
  overlay.addEventListener('click', endTutorial);

  btnNext.addEventListener('click', ()=>{
    const next = stepIdx + 1;
    if (next >= steps.length){ endTutorial(); return; }
    showStep(next);
  });

  // Öffentlich machen: Startfunktion
  window.startStudentTutorial = function(){
    // Schritt-Ziele (Video-Button, dann Info-Button). Falls die Home-Infoleiste existiert, nimm diese vorrangig.
    const videoBtn = document.querySelector('.introBtn');
    const infoBtn  = document.querySelector('.home-tools .linksBtn')
                      || document.querySelector('#slide .linksBtn')
                      || document.querySelector('.linksBtn');

    steps = [
      { el: videoBtn, text: 'Schau dir die Lernsituation (Video) an.' },
      { el: infoBtn,  text: 'Unter dem i findest du wichtige Informationen und Weiterleitungen.' }
    ].filter(s => !!s.el); // falls Element nicht da ist, Schritt überspringen

    if (steps.length === 0){ return; }
    // Kleines Delay, falls Layout/Animation gerade läuft
    setTimeout(()=> showStep(0), 200);
  };
})();

// === Bereichs-/Polygon-Tutorial: einmal pro Bereich (Slug) — ERSETZT ===
(function(){
  const LS_KEY_PREFIX = 'area_tut_seen_';

  // nutzt deine vorhandenen Layer
  const overlay = document.getElementById('tutOverlay');
  const focus   = document.getElementById('tutFocus');
  const arrow   = document.getElementById('tutArrow');
  const tip     = document.getElementById('tutTip');
  const tipText = document.getElementById('tutText');
  let btnSkip = document.getElementById('tutSkip');
  let btnNext = document.getElementById('tutNext');

  let currentEl = null;
  let relayoutBound = null;

  function placeAt(el){
    if (!el) return;
    const r  = el.getBoundingClientRect();
    const sx = window.scrollX, sy = window.scrollY;

    // Fokusrahmen direkt um das Ziel
    focus.style.cssText =
      `display:block; left:${r.left-8+sx}px; top:${r.top-8+sy}px; width:${r.width+16}px; height:${r.height+16}px;`;
    // Pfeil oberhalb mittig
    arrow.style.cssText =
      `display:block; left:${r.left + r.width/2 - 17 + sx}px; top:${Math.max(8, r.top - 40) + sy}px;`;

    // Tooltip rechts vom Ziel, bei Platzmangel darunter
    const vw = document.documentElement.clientWidth;
    const rightPref = r.right + 12 + sx;
    const tipLeft   = (rightPref + 320 < sx + vw) ? rightPref : (r.left + sx);
    const tipTop    = (tipLeft === rightPref) ? (r.top + sy - 4) : (r.bottom + 12 + sy);

    tip.style.cssText = `display:block; left:${tipLeft}px; top:${tipTop}px;`;

    overlay.style.display = 'block';
    focus.style.display   = 'block';
    arrow.style.display   = 'block';
    tip.style.display     = 'block';
  }

  function hideAll(){
    overlay.style.display = 'none';
    focus.style.display   = 'none';
    arrow.style.display   = 'none';
    tip.style.display     = 'none';
    if (relayoutBound){
      window.removeEventListener('resize', relayoutBound);
      window.removeEventListener('scroll',  relayoutBound);
      relayoutBound = null;
    }
  }

  window.startAreaTutorialOnce = function(slug){
    const key = (slug ? LS_KEY_PREFIX + slug : LS_KEY_PREFIX + 'default');
    if (localStorage.getItem(key)) return; // nur einmal pro Bereich
    // Alte Listener vom Schüler-Tutorial abkoppeln:
        btnNext.replaceWith(btnNext.cloneNode(true));
        btnSkip.replaceWith(btnSkip.cloneNode(true));
        // Refs aktualisieren
        btnNext = document.getElementById('tutNext');
        btnSkip = document.getElementById('tutSkip');

    // ---- Ziel-Elemente in Reihenfolge LINKS → RECHTS ----
    const stepDefs = [
      { el: document.getElementById('backBtn'),
        text: 'Home-Button – kehrt zum Startbildschirm zurück.' },

      { el: document.getElementById('nextBgBtn'),
        text: 'Bilder – enthält Bilder des Projektbereichs.' },

      { el: document.querySelector('#slide .introBtn'),
        text: 'Video – enthält Videos zum Projektbereich.' },

      { el: document.querySelector('#slide .linksBtn'),
        text: 'Info-Button – hier findest du wichtige Informationen & Weiterleitungen.' },

      // Fokus auf den grünen Infobereich / Projektbeschreibung
      { el: document.querySelector('#slideDesc .info-card')
            || document.querySelector('#slideDesc .info-content')
            || document.getElementById('slideDesc'),
        text: 'Projektbeschreibung – hier stehen die wichtigsten Inhalte zum Bereich.' }
    ].filter(s => !!s.el);

    if (stepDefs.length === 0) return;

    let step = 0;

    const showStep = (i)=>{
      step = i;
      const target = stepDefs[step].el;
      tipText.textContent = stepDefs[step].text;
      placeAt(target);

      if (!relayoutBound){
        relayoutBound = ()=> placeAt(stepDefs[step].el);
        window.addEventListener('resize', relayoutBound);
        window.addEventListener('scroll',  relayoutBound, { passive:true });
      } else {
        // beim Schrittwechsel neu binden, damit der Pfeil dem neuen Ziel folgt
        window.removeEventListener('resize', relayoutBound);
        window.removeEventListener('scroll',  relayoutBound);
        relayoutBound = ()=> placeAt(stepDefs[step].el);
        window.addEventListener('resize', relayoutBound);
        window.addEventListener('scroll',  relayoutBound, { passive:true });
      }
    };

    const finish = ()=>{ hideAll(); localStorage.setItem(key,'1'); };

    btnSkip.onclick = finish;
    overlay.onclick = finish;
    btnNext.onclick = ()=>{
      const next = step + 1;
      if (next >= stepDefs.length) finish();
      else showStep(next);
    };

    // kleines Delay, falls die Slide gerade animiert
    setTimeout(()=> showStep(0), 200);
  };
})();
// === NEU: Minimaler Tutorial-Button (oben links, nur auf "normalen" Slides) ===
(function(){
  function isNormalSlide(slideEl){
    if (!slideEl) return false;
    const isVideo = slideEl.matches('[data-page-type="video"], .slide--video')
                 || !!slideEl.querySelector('video, iframe[src*="youtube"], iframe[src*="vimeo"]');
    const isInfo  = slideEl.matches('[data-page-type="info"], .slide--info')
                 || !!slideEl.querySelector('.info, .info-page');
    return !(isVideo || isInfo);
  }

  function startAreaTutorialManual(slug){
    // Falls dein "Once"-Flow benutzt wird, gesehen-Flag entfernen
    try { localStorage.removeItem('area_tut_seen_' + (slug || 'default')); } catch(e){}
    if (typeof window.startAreaTutorialOnce === 'function') {
      window.startAreaTutorialOnce(slug);
    }
  }

  window.buildTutorialButtonForSlide = function(){
        const slide = document.getElementById('slide');
      // slug optional; wenn leer, startet das Default-Tutorial
      const slug  = (typeof window.lastAreaSlug === 'string') ? window.lastAreaSlug : '';
      
      if (!slide) { document.getElementById('areaTutBtn')?.remove(); return; }
      // KEIN isNormalSlide-Check, KEIN Pflicht-slug


    // Anker sicherstellen (#areaTutFloat existiert bereits in deinem HTML/CSS)
    let anchor = document.getElementById('areaTutFloat');
    if (!anchor) {
      anchor = document.createElement('div');
      anchor.id = 'areaTutFloat';
      slide.appendChild(anchor);
    }

    // Button (Style .tool-btn, Icon: rotes Fragezeichen, Label "Tutorial")
    let btn = document.getElementById('areaTutBtn');
    if (!btn) {
      btn = document.createElement('button');
      btn.id = 'areaTutBtn';
      btn.type = 'button';
      btn.className = 'tool-btn';
      btn.title = 'Bereichs-Tutorial starten';
      btn.innerHTML = '<span class="tool-icon">❓</span><span class="label">Tutorial</span>';
    } else {
      btn.classList.add('tool-btn');
      (btn.querySelector('.tool-icon') || btn.firstElementChild)?.classList.add('tool-icon');
    }

    // alte Listener durch Klonen entfernen, dann Klick binden
    const fresh = btn.cloneNode(true);
    fresh.addEventListener('click', (e)=>{
      e.preventDefault();
      startAreaTutorialManual(slug);
    });

    // einhängen
    if (btn.parentElement !== anchor) anchor.appendChild(fresh);
    else btn.replaceWith(fresh);
  };
})();


  </script>
  

</body>
</html>
